<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŒ¢å¹£ç¸½å€¼å¤§æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            user-select: none;
        }

        .money-img {
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            transition: transform 0.2s;
            cursor: pointer;
            width: 80%;
            max-width: 120px;
            height: auto;
            border-radius: 50%;
            object-fit: contain;
        }

        .money-img:hover {
            transform: scale(1.1);
            filter: brightness(1.1);
        }

        .money-wrapper.shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-5deg); }
            50% { transform: translateX(5px) rotate(5deg); }
            75% { transform: translateX(-5px) rotate(-5deg); }
            100% { transform: translateX(0); }
        }

        .hint-bubble {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1.2rem;
            font-weight: 800;
            color: #16a34a;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 0.2em 0.5em;
            border-radius: 9999px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 2px solid #dcfce7;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            pointer-events: none;
            white-space: nowrap;
        }

        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .keypad-btn {
            transition: background-color 0.1s, transform 0.1s;
        }
        .keypad-btn:active {
            transform: scale(0.95);
        }

        @keyframes flash-green {
            0% { background-color: #dcfce7; }
            50% { background-color: #86efac; }
            100% { background-color: #dcfce7; }
        }
        .bg-flash-success {
            animation: flash-green 1s infinite;
        }

        /* å¡«ç©ºé¡Œçš„ç©ºæ ¼æ¨£å¼ */
        .blank-box {
            display: inline-block;
            min-width: 60px;
            padding: 2px 8px;
            margin: 0 4px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            background-color: #fff;
            color: #1e3a8a;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-family: monospace;
            vertical-align: middle;
        }
        
        .blank-box:empty::before {
            content: '?';
            color: #94a3b8;
        }

        .blank-box.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            transform: scale(1.1);
        }

        .blank-box.correct {
            border-color: #22c55e;
            background-color: #f0fdf4;
            color: #15803d;
            font-weight: bold;
            cursor: default;
        }

        .blank-box.disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
            border-color: #e2e8f0;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- é ‚éƒ¨æ¨¡å¼é¸æ“‡ -->
    <header class="bg-white shadow-md p-2 z-10 relative">
        <div class="max-w-7xl mx-auto relative flex flex-col items-center">
            <h1 class="text-xl md:text-2xl font-bold text-center text-blue-800 mb-2 w-full">éŒ¢å¹£ç¸½å€¼å¤§æŒ‘æˆ°</h1>
            
            <button id="random-btn" onclick="toggleRandomMode()" class="absolute right-0 top-0 mt-1 mr-2 px-3 py-1 rounded shadow text-sm font-bold transition-all bg-gray-200 text-gray-600 hover:bg-gray-300">
                <i class="fas fa-random mr-1"></i> éš¨æ©Ÿæ¨¡å¼ï¼šé—œ
            </button>

            <div class="flex flex-wrap justify-center gap-2" id="mode-buttons">
                <!-- æŒ‰éˆ•ç”± JS ç”Ÿæˆ -->
            </div>
        </div>
    </header>

    <!-- éŠæˆ²ä¸»å€åŸŸ -->
    <main class="flex-1 flex flex-col md:flex-row h-full overflow-hidden">
        
        <!-- å·¦æ–¹ï¼šé¡Œç›®é¡¯ç¤ºå€ -->
        <div class="w-full md:w-2/3 bg-blue-50 flex flex-col border-b md:border-b-0 md:border-r border-blue-200">
            
            <!-- é¡Œç›®è³‡è¨Šæ¢ -->
            <div class="flex justify-between items-center p-4">
                <div class="bg-white px-4 py-2 rounded-full shadow text-blue-600 font-bold text-lg whitespace-nowrap">
                    é¡Œç›®ï¼š<span id="progress-display">1 / 10</span>
                </div>
                <div id="instruction-text" class="text-lg text-gray-700 font-bold text-center flex-1 mx-4">
                    éš¨æ™‚é»æ“ŠéŒ¢å¹£å‡ºç¾æç¤º
                </div>
            </div>

            <!-- ç¡¬å¹£æ»¾å‹•å€åŸŸ -->
            <div class="flex-1 overflow-y-auto flex justify-center items-start p-2">
                <div id="banknotes-area" class="grid grid-cols-5 gap-4 w-full max-w-4xl p-2 auto-rows-min justify-items-center">
                    <!-- éŒ¢å¹£åœ–ç‰‡å°‡åœ¨æ­¤ç”Ÿæˆ -->
                </div>
            </div>

            <!-- åº•éƒ¨ï¼šå¥å­é¡¯ç¤ºèˆ‡ä¸‹ä¸€é¡ŒæŒ‰éˆ•å€åŸŸ (å›ºå®šåœ¨åº•éƒ¨) -->
            <div class="w-full bg-blue-100/50 p-4 border-t border-blue-200 flex flex-col items-center justify-center min-h-[140px]">
                
                <!-- é¡Œç›®/ç­”æ¡ˆå¥å­ -->
                <div id="question-sentence" class="text-xl md:text-2xl font-bold text-blue-900 mb-2 bg-white px-6 py-3 rounded-xl shadow-sm border-2 border-blue-100 text-center transition-all leading-loose">
                    <!-- é€™è£¡æœƒå‹•æ…‹é¡¯ç¤º -->
                </div>
                
                <!-- ä¸‹ä¸€é¡ŒæŒ‰éˆ• (åˆå§‹éš±è—) -->
                <button id="next-btn" onclick="nextQuestion()" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-12 rounded-full text-xl shadow-lg transform transition hover:scale-105 flex items-center gap-2">
                    ä¸‹ä¸€é¡Œ <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- å³æ–¹ï¼šè¼¸å…¥æ§åˆ¶å€ -->
        <div class="w-full md:w-1/3 bg-white p-4 flex flex-col items-center justify-center shadow-lg z-20">
            
            <div class="w-full max-w-xs mb-4">
                <div id="feedback-msg" class="text-center h-8 mt-1 font-bold text-lg">è«‹è¼¸å…¥æ•¸å­—ä¸¦æŒ‰ç¢ºå®š</div>
            </div>

            <!-- æ•¸å­—éµç›¤ -->
            <div class="grid grid-cols-3 gap-2 w-full max-w-xs">
                <button class="keypad-btn bg-blue-100 hover:bg-blue-200 text-blue-800 text-2xl font-bold py-3 rounded-lg shadow" onclick="appendNumber('1')">1</button>
                <button class="keypad-btn bg-blue-100 hover:bg-blue-200 text-blue-800 text-2xl font-bold py-3 rounded-lg shadow" onclick="appendNumber('2')">2</button>
                <button class="keypad-btn bg-blue-100 hover:bg-blue-200 text-blue-800 text-2xl font-bold py-3 rounded-lg shadow" onclick="appendNumber('3')">3</button>
                
                <button class="keypad-btn bg-blue-100 hover:bg-blue-200 text-blue-800 text-2xl font-bold py-3 rounded-lg shadow" onclick="appendNumber('4')">4</button>
                <button class="keypad-btn bg-blue-100 hover:bg-blue-200 text-blue-800 text-2xl font-bold py-3 rounded-lg shadow" onclick="appendNumber('5')">5</button>
                <button class="keypad-btn bg-blue-100 hover:bg-blue-200 text-blue-800 text-2xl font-bold py-3 rounded-lg shadow" onclick="appendNumber('6')">6</button>
                
                <button class="keypad-btn bg-blue-100 hover:bg-blue-200 text-blue-800 text-2xl font-bold py-3 rounded-lg shadow" onclick="appendNumber('7')">7</button>
                <button class="keypad-btn bg-blue-100 hover:bg-blue-200 text-blue-800 text-2xl font-bold py-3 rounded-lg shadow" onclick="appendNumber('8')">8</button>
                <button class="keypad-btn bg-blue-100 hover:bg-blue-200 text-blue-800 text-2xl font-bold py-3 rounded-lg shadow" onclick="appendNumber('9')">9</button>
                
                <!-- åˆªé™¤èˆ‡æ¸…é™¤ -->
                <button class="keypad-btn bg-red-100 hover:bg-red-200 text-red-600 text-2xl font-bold py-3 rounded-lg shadow" onclick="deleteNumber()"><i class="fas fa-backspace"></i></button>
                <button class="keypad-btn bg-blue-100 hover:bg-blue-200 text-blue-800 text-2xl font-bold py-3 rounded-lg shadow" onclick="appendNumber('0')">0</button>
                <button class="keypad-btn bg-yellow-100 hover:bg-yellow-200 text-yellow-700 text-xl font-bold py-3 rounded-lg shadow" onclick="clearInput()">æ¸…é™¤</button>
                
                <!-- ç¢ºå®šæŒ‰éˆ•æ©«è·¨ä¸‰æ¬„ -->
                <button id="confirm-btn" class="col-span-3 keypad-btn bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-3 rounded-lg shadow mt-1" onclick="checkAnswer()">ç¢ºå®š</button>
            </div>
        </div>
    </main>

    <!-- å®Œæˆç•«é¢ -->
    <div id="completion-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md mx-4 animate-bounce-in">
            <div class="text-6xl mb-4">ğŸ†</div>
            <h2 class="text-3xl font-bold text-blue-800 mb-4">æ­å–œå®Œæˆï¼</h2>
            <p class="text-gray-600 mb-6 text-lg">ä½ çœŸæ˜¯å¤ªæ£’äº†ï¼</p>
            <button onclick="resetGame()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg transition transform hover:scale-105">
                å†ç©ä¸€æ¬¡
            </button>
        </div>
    </div>

    <script>
        // éŠæˆ²é…ç½®æ•¸æ“š
        const CONFIG = {
            // mode 'mixed' ç‚ºæ··åˆç¡¬å¹£
            modes: [0.1, 0.2, 0.5, 1, 2, 5, 10, 'mixed'],
            images: {
                0.1: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/1è§’æ­£é¢.png",
                0.2: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/2è§’æ­£é¢.png",
                0.5: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/5è§’æ­£é¢.png",
                1: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/1å…ƒæ­£é¢.png",
                2: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/2å…ƒæ­£é¢.png",
                5: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/5å…ƒæ­£é¢.png",
                10: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/10å…ƒæ­£é¢.png"
            }
        };

        // é¡¯ç¤ºåç¨±æ˜ å°„
        function getModeLabel(val) {
            if (val === 'mixed') return 'æ··åˆç¡¬å¹£';
            if (val < 1) {
                return (val * 10) + "è§’";
            }
            return val + "å…ƒ";
        }

        // éŠæˆ²éšæ®µ
        const PHASES = {
            SIMPLE: 'simple',        // å–®ä¸€ç¡¬å¹£æ•´æ•¸æ¨¡å¼
            CENT_TOTAL: 'cent_total', // å–®ä¸€ç¡¬å¹£è§’æ¨¡å¼ï¼šç®—ç¸½è§’æ•¸
            CENT_CONVERT_YUAN: 'cent_convert_yuan', // å–®ä¸€ç¡¬å¹£ï¼šæ›ç®—-å¡«å…ƒ
            CENT_CONVERT_CENT: 'cent_convert_cent', // å–®ä¸€ç¡¬å¹£ï¼šæ›ç®—-å¡«è§’
            MIXED_PHASE_1: 'mixed_phase_1', // æ··åˆç¡¬å¹£ï¼šå¡«å…ƒèˆ‡è§’
            MIXED_PHASE_2: 'mixed_phase_2'  // æ··åˆç¡¬å¹£ï¼šé€²ä½æ›ç®—
        };

        let currentState = {
            mode: 1, 
            isRandomMode: false,
            questionQueue: [], 
            currentQueueIndex: 0,
            
            // æ··åˆæ¨¡å¼å°ˆç”¨
            currentCoins: [], // ç•¶å‰é¡Œç›®çš„ç¡¬å¹£åˆ—è¡¨
            sortedCoins: [], // æ­£ç¢ºé †åºçš„ç¡¬å¹£åˆ—è¡¨ (ç”¨æ–¼éš¨æ©Ÿæ¨¡å¼é©—è­‰)
            displayCoins: [], // é¡¯ç¤ºé †åºçš„ç¡¬å¹£åˆ—è¡¨
            hintIndex: 0, 
            currentYuanAcc: 0, // é»æ“Šç´¯è¨ˆå…ƒ
            currentJiaoAcc: 0, // é»æ“Šç´¯è¨ˆè§’
            targetYuan: 0,     // ç›®æ¨™å…ƒ (ç­”æ¡ˆ)
            targetJiao: 0,     // ç›®æ¨™è§’ (ç­”æ¡ˆ)
            
            // å–®ä¸€æ¨¡å¼å°ˆç”¨
            hintsRevealed: [], 
            nextHintIndex: 0,
            
            phase: PHASES.SIMPLE,
            activeBlankId: null // ç•¶å‰å•Ÿç”¨çš„è¼¸å…¥æ¡†ID
        };

        function init() {
            renderModeButtons();
            startGame(1);
        }

        function toggleRandomMode() {
            currentState.isRandomMode = !currentState.isRandomMode;
            const btn = document.getElementById('random-btn');
            if (currentState.isRandomMode) {
                btn.innerHTML = '<i class="fas fa-random mr-1"></i> éš¨æ©Ÿæ¨¡å¼ï¼šé–‹';
                btn.classList.remove('bg-gray-200', 'text-gray-600');
                btn.classList.add('bg-purple-600', 'text-white', 'hover:bg-purple-700');
            } else {
                btn.innerHTML = '<i class="fas fa-random mr-1"></i> éš¨æ©Ÿæ¨¡å¼ï¼šé—œ';
                btn.classList.add('bg-gray-200', 'text-gray-600');
                btn.classList.remove('bg-purple-600', 'text-white', 'hover:bg-purple-700');
            }
            startGame(currentState.mode);
        }

        function generateQueue() {
            if (currentState.mode === 'mixed') {
                const queue = [];
                for(let q=0; q<10; q++) {
                    // éš¨æ©Ÿç”Ÿæˆ 4-10 (ä¸€èˆ¬) æˆ– 4-6 (éš¨æ©Ÿæ¨¡å¼) å€‹ç¡¬å¹£
                    const min = 4;
                    const max = currentState.isRandomMode ? 6 : 10;
                    const count = Math.floor(Math.random() * (max - min + 1)) + min;
                    
                    const coins = [];
                    const values = [0.1, 0.2, 0.5, 1, 2, 5, 10];
                    for(let i=0; i<count; i++) {
                        coins.push(values[Math.floor(Math.random() * values.length)]);
                    }
                    // å§‹çµ‚å„²å­˜ç‚ºç”±å¤§åˆ°å°
                    coins.sort((a, b) => b - a);
                    queue.push(coins);
                }
                return queue;
            } else {
                // å–®ä¸€æ¨¡å¼
                let allQuestions = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
                if (currentState.isRandomMode) {
                    for (let i = allQuestions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [allQuestions[i], allQuestions[j]] = [allQuestions[j], allQuestions[i]];
                    }
                    return allQuestions;
                }
                return allQuestions;
            }
        }

        function renderModeButtons() {
            const container = document.getElementById('mode-buttons');
            container.innerHTML = '';
            CONFIG.modes.forEach(mode => {
                const btn = document.createElement('button');
                btn.className = `px-3 py-1 rounded-full border-2 font-bold text-sm transition-colors duration-200 min-w-[3rem]
                    ${currentState.mode === mode ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-blue-600 border-blue-300 hover:bg-blue-50'}`;
                btn.innerText = getModeLabel(mode);
                btn.onclick = () => startGame(mode);
                btn.id = `mode-btn-${mode}`;
                container.appendChild(btn);
            });
        }

        function updateModeButtons() {
            CONFIG.modes.forEach(mode => {
                const btn = document.getElementById(`mode-btn-${mode}`);
                if (currentState.mode === mode) {
                    btn.className = 'px-3 py-1 rounded-full border-2 font-bold text-sm transition-colors duration-200 bg-blue-600 text-white border-blue-600 shadow-md transform scale-105 min-w-[3rem]';
                } else {
                    btn.className = 'px-3 py-1 rounded-full border-2 font-bold text-sm transition-colors duration-200 bg-white text-blue-600 border-blue-300 hover:bg-blue-50 min-w-[3rem]';
                }
            });
        }

        function startGame(mode) {
            currentState.mode = mode;
            currentState.questionQueue = generateQueue();
            currentState.currentQueueIndex = 0;
            
            updateModeButtons();
            document.getElementById('completion-modal').classList.add('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            const data = currentState.questionQueue[currentState.currentQueueIndex];
            
            // é‡ç½®ç‹€æ…‹
            currentState.hintsRevealed = [];
            currentState.activeBlankId = null;
            document.getElementById('feedback-msg').innerText = "è«‹è¼¸å…¥æ•¸å­—ä¸¦æŒ‰ç¢ºå®š";
            document.getElementById('next-btn').classList.add('hidden');

            if (currentState.mode === 'mixed') {
                currentState.sortedCoins = [...data]; // æ­£ç¢ºé †åº (å¤§->å°)
                currentState.currentCoins = [...data];
                
                // è¨ˆç®—æ­£ç¢ºç­”æ¡ˆ (ä¸ä¾è³´é»æ“Š)
                currentState.targetYuan = 0;
                currentState.targetJiao = 0;
                currentState.currentCoins.forEach(coin => {
                    if (coin >= 1) {
                        currentState.targetYuan += coin;
                    } else {
                        currentState.targetJiao += Math.round(coin * 10);
                    }
                });

                // æ±ºå®šé¡¯ç¤ºé †åº
                if (currentState.isRandomMode) {
                    // éš¨æ©Ÿæ‰“äº‚é¡¯ç¤º
                    currentState.displayCoins = data.map((val, idx) => ({val, originalIdx: idx}))
                        .sort(() => Math.random() - 0.5);
                    document.getElementById('instruction-text').innerText = "å¯ç›´æ¥ä½œç­”ï¼Œæˆ–ä¾é¢å€¼ç”±å¤§è‡³å°é»æ“Šæç¤º";
                } else {
                    // æ­£å¸¸é¡¯ç¤º (å·²æ’åº)
                    currentState.displayCoins = data.map((val, idx) => ({val, originalIdx: idx}));
                    document.getElementById('instruction-text').innerText = "å¯ç›´æ¥ä½œç­”ï¼Œæˆ–ç”±å·¦è‡³å³é»æ“Šæç¤º";
                }

                currentState.hintIndex = 0;
                currentState.currentYuanAcc = 0;
                currentState.currentJiaoAcc = 0;
                currentState.hintsRevealed = new Array(data.length).fill(false);
                currentState.phase = PHASES.MIXED_PHASE_1;
                
                renderMoneyMixed();
                renderSentenceMixed();

            } else {
                // å–®ä¸€æ¨¡å¼é‚è¼¯
                currentState.noteCount = data + 1;
                currentState.nextHintIndex = 0;
                currentState.hintsRevealed = new Array(currentState.noteCount).fill(false);
                document.getElementById('instruction-text').innerText = "é»æ“Šç¡¬å¹£å¯é¡¯ç¤ºé‡‘é¡æç¤º";
                
                if (currentState.mode < 1) {
                    currentState.phase = PHASES.CENT_TOTAL;
                } else {
                    currentState.phase = PHASES.SIMPLE;
                }
                
                renderMoney(currentState.noteCount);
                renderSentence();
            }

            const totalQs = currentState.questionQueue.length;
            document.getElementById('progress-display').innerText = `${currentState.currentQueueIndex + 1} / ${totalQs}`;
        }

        // ================= æ¸²æŸ“é‚è¼¯ =================

        // å–®ä¸€æ¨¡å¼æ¸²æŸ“ç¡¬å¹£
        function renderMoney(count) {
            const container = document.getElementById('banknotes-area');
            container.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = "relative group w-full flex justify-center money-wrapper"; 
                const img = document.createElement('img');
                img.src = CONFIG.images[currentState.mode];
                img.className = `money-img rounded-full shadow-sm border border-gray-200`;
                wrapper.onclick = () => handleNoteClick(i, wrapper);
                wrapper.appendChild(img);
                container.appendChild(wrapper);
            }
        }

        // æ··åˆæ¨¡å¼æ¸²æŸ“ç¡¬å¹£
        function renderMoneyMixed() {
            const container = document.getElementById('banknotes-area');
            container.innerHTML = '';
            
            currentState.displayCoins.forEach((item, displayIdx) => {
                const wrapper = document.createElement('div');
                wrapper.className = "relative group w-full flex justify-center money-wrapper";
                wrapper.id = `coin-wrapper-${displayIdx}`;
                
                const img = document.createElement('img');
                img.src = CONFIG.images[item.val];
                img.className = `money-img rounded-full shadow-sm border border-gray-200`;
                
                // é»æ“Šäº‹ä»¶ï¼šå‚³å…¥æ­¤ç¡¬å¹£çš„é¢å€¼å’Œå®ƒåœ¨é¡¯ç¤ºé™£åˆ—ä¸­çš„ä½ç½®
                wrapper.onclick = () => handleMixedCoinClick(item.val, displayIdx, wrapper);
                
                wrapper.appendChild(img);
                container.appendChild(wrapper);
            });
        }

        // å–®ä¸€æ¨¡å¼æ¸²æŸ“å¥å­
        function renderSentence() {
            const container = document.getElementById('question-sentence');
            const label = getModeLabel(currentState.mode);
            
            if (currentState.phase === PHASES.SIMPLE) {
                container.innerHTML = `${currentState.noteCount}å€‹${label}çš„ç¸½å€¼æ˜¯ <span id="blank-1" class="blank-box" onclick="activateBlank('blank-1')"></span> å…ƒ`;
                activateBlank('blank-1');
            } else {
                if (currentState.phase === PHASES.CENT_TOTAL) {
                    container.innerHTML = `${currentState.noteCount}å€‹${label}çš„ç¸½å€¼æ˜¯ <span id="blank-1" class="blank-box" onclick="activateBlank('blank-1')"></span> è§’`;
                    activateBlank('blank-1');
                } else {
                    const totalCents = Math.round(currentState.noteCount * currentState.mode * 10);
                    let html = `${currentState.noteCount}å€‹${label}çš„ç¸½å€¼æ˜¯ <span class="text-green-600 font-bold mx-1">${totalCents}</span> è§’<br>`;
                    html += `<span class="text-sm text-gray-400 block my-1">æ›ç®—ç‚º</span>`;
                    html += `${currentState.noteCount}å€‹${label}çš„ç¸½å€¼æ˜¯ `;
                    
                    if (currentState.phase === PHASES.CENT_CONVERT_YUAN) {
                        html += `<span id="blank-yuan" class="blank-box" onclick="activateBlank('blank-yuan')"></span> å…ƒ <span id="blank-cent" class="blank-box disabled"></span> è§’`;
                        container.innerHTML = html;
                        activateBlank('blank-yuan');
                    } else if (currentState.phase === PHASES.CENT_CONVERT_CENT) {
                        const correctYuan = Math.floor(totalCents / 10);
                        html += `<span class="text-green-600 font-bold mx-1">${correctYuan}</span> å…ƒ <span id="blank-cent" class="blank-box" onclick="activateBlank('blank-cent')"></span> è§’`;
                        container.innerHTML = html;
                        activateBlank('blank-cent');
                    }
                }
            }
        }

        // æ··åˆæ¨¡å¼æ¸²æŸ“å¥å­
        function renderSentenceMixed() {
            const container = document.getElementById('question-sentence');
            
            if (currentState.phase === PHASES.MIXED_PHASE_1) {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“ç­”å°å…ƒ
                const yuanDone = document.getElementById('mix-yuan')?.classList.contains('correct');
                // å¦‚æœæ˜¯åˆå§‹åŒ–æˆ–è€…å‰›ç­”å°å®Œå…ƒï¼Œéœ€è¦é‡æ–°æ¸²æŸ“çµæ§‹ï¼ˆæˆ–ä¿æŒçµæ§‹æ›´æ–°ç‹€æ…‹ï¼‰
                // ç°¡å–®èµ·è¦‹ï¼Œç›´æ¥é‡ç¹ªï¼Œä½†è¦ä¿ç•™å·²å¡«çš„å€¼
                
                // é€™è£¡æˆ‘å€‘ç›´æ¥ç”ŸæˆHTMLï¼Œä¸¦æ ¹æ“šé‚è¼¯é–å®š
                // åˆå§‹ç‹€æ…‹ï¼šYuan Active, Jiao Disabled
                
                let yuanClass = "blank-box";
                let jiaoClass = "blank-box disabled"; // é è¨­è§’æ˜¯é–å®šçš„
                let yuanVal = "";
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“
                container.innerHTML = `é€™äº›ç¡¬å¹£çš„ç¸½å€¼ <span id="mix-yuan" class="${yuanClass}" onclick="activateBlank('mix-yuan')"></span> å…ƒ <span id="mix-jiao" class="${jiaoClass}" onclick="activateBlank('mix-jiao')"></span> è§’`;
                activateBlank('mix-yuan');

            } else if (currentState.phase === PHASES.MIXED_PHASE_2) {
                // Phase 1 å·²å®Œæˆï¼Œé¡¯ç¤ºéœæ…‹çµæœä¸¦è¿½åŠ æ›ç®—é¡Œ
                const totalYuan = currentState.targetYuan;
                const totalJiao = currentState.targetJiao;
                
                let html = `é€™äº›ç¡¬å¹£çš„ç¸½å€¼ <span class="text-green-600 font-bold mx-1">${totalYuan}</span> å…ƒ <span class="text-green-600 font-bold mx-1">${totalJiao}</span> è§’`;
                html += `<br><span class="text-sm text-gray-400 block my-1">æ›ç®—ç‚º</span>`;
                html += `é€™äº›ç¡¬å¹£çš„ç¸½å€¼ <span id="mix-yuan-2" class="blank-box" onclick="activateBlank('mix-yuan-2')"></span> å…ƒ <span id="mix-jiao-2" class="blank-box disabled" onclick="activateBlank('mix-jiao-2')"></span> è§’`;
                
                container.innerHTML = html;
                activateBlank('mix-yuan-2');
            }
        }

        // ================= äº’å‹•é‚è¼¯ =================

        // å–®ä¸€æ¨¡å¼é»æ“Šç¡¬å¹£
        function handleNoteClick(index, wrapperElement) {
            if (index !== currentState.nextHintIndex) return;
            if (currentState.hintsRevealed[index]) return;

            let displayValue;
            if (currentState.mode < 1) {
                displayValue = Math.round((index + 1) * currentState.mode * 10);
            } else {
                displayValue = Math.round((index + 1) * currentState.mode * 10) / 10;
            }
            
            showHint(wrapperElement, displayValue);
            currentState.hintsRevealed[index] = true;
            currentState.nextHintIndex++;
        }

        // æ··åˆæ¨¡å¼é»æ“Šç¡¬å¹£ (æç¤ºç”¨ï¼Œä¸å½±éŸ¿ä½œç­”é©—è­‰)
        function handleMixedCoinClick(val, displayIdx, wrapperElement) {
            if (wrapperElement.querySelector('.hint-bubble')) return;

            const expectedVal = currentState.sortedCoins[currentState.hintIndex];
            let isCorrect = false;

            if (currentState.isRandomMode) {
                if (Math.abs(val - expectedVal) < 0.001) isCorrect = true;
            } else {
                if (displayIdx === currentState.hintIndex) isCorrect = true;
            }

            if (isCorrect) {
                if (val >= 1) {
                    currentState.currentYuanAcc += val;
                    showHint(wrapperElement, currentState.currentYuanAcc + "å…ƒ");
                } else {
                    currentState.currentJiaoAcc += Math.round(val * 10);
                    showHint(wrapperElement, currentState.currentJiaoAcc + "è§’");
                }
                currentState.hintIndex++;
            } else {
                wrapperElement.classList.add('shake');
                setTimeout(() => wrapperElement.classList.remove('shake'), 500);
            }
        }

        function showHint(el, text) {
            const bubble = document.createElement('div');
            bubble.className = "hint-bubble";
            bubble.innerText = text;
            el.appendChild(bubble);
        }

        // ================= è¼¸å…¥èˆ‡éµç›¤ =================

        function activateBlank(id) {
            // å¦‚æœå·²ç¶“å®Œæˆè©²é¡Œï¼Œç¦æ­¢åˆ‡æ›
            if (!document.getElementById('next-btn').classList.contains('hidden')) return;

            const el = document.getElementById(id);
            if (!el || el.classList.contains('disabled') || el.classList.contains('correct')) return;

            // ç§»é™¤èˆŠçš„ active
            if (currentState.activeBlankId) {
                const old = document.getElementById(currentState.activeBlankId);
                if (old) old.classList.remove('active');
            }
            
            currentState.activeBlankId = id;
            el.classList.add('active');
            document.getElementById('feedback-msg').innerText = "è«‹è¼¸å…¥æ•¸å­—ä¸¦æŒ‰ç¢ºå®š";
        }

        function appendNumber(num) {
            if (!currentState.activeBlankId) return;
            const el = document.getElementById(currentState.activeBlankId);
            if (!el) return;

            // é™åˆ¶é•·åº¦
            if (el.innerText.length < 4) {
                el.innerText += num;
            }
        }

        function deleteNumber() {
            if (!currentState.activeBlankId) return;
            const el = document.getElementById(currentState.activeBlankId);
            if (el) {
                el.innerText = el.innerText.slice(0, -1);
            }
        }

        function clearInput() {
            if (!currentState.activeBlankId) return;
            const el = document.getElementById(currentState.activeBlankId);
            if (el) el.innerText = "";
        }

        function checkAnswer() {
            if (!document.getElementById('next-btn').classList.contains('hidden')) return;
            if (!currentState.activeBlankId) return;
            
            let isCorrect = false;
            let val = parseInt(document.getElementById(currentState.activeBlankId).innerText, 10);
            if (isNaN(val)) return;

            // 1. å–®ä¸€æ¨¡å¼é©—è­‰
            if (currentState.mode !== 'mixed') {
                const totalCents = Math.round(currentState.noteCount * currentState.mode * 10);
                const totalValue = Math.round(currentState.noteCount * currentState.mode * 10) / 10;

                if (currentState.phase === PHASES.SIMPLE) {
                    if (val === totalValue) isCorrect = true;
                } else if (currentState.phase === PHASES.CENT_TOTAL) {
                    if (val === totalCents) isCorrect = true;
                } else if (currentState.phase === PHASES.CENT_CONVERT_YUAN) {
                    const correctYuan = Math.floor(totalCents / 10);
                    if (val === correctYuan) isCorrect = true;
                } else if (currentState.phase === PHASES.CENT_CONVERT_CENT) {
                    const correctCent = totalCents % 10;
                    if (val === correctCent) isCorrect = true;
                }
            } 
            // 2. æ··åˆæ¨¡å¼é©—è­‰ (åˆ†æ­¥)
            else {
                if (currentState.phase === PHASES.MIXED_PHASE_1) {
                    if (currentState.activeBlankId === 'mix-yuan') {
                        if (val === currentState.targetYuan) isCorrect = true;
                    } else if (currentState.activeBlankId === 'mix-jiao') {
                        if (val === currentState.targetJiao) isCorrect = true;
                    }
                } else if (currentState.phase === PHASES.MIXED_PHASE_2) {
                    const totalCents = (currentState.targetYuan * 10) + currentState.targetJiao;
                    const correctYuan = Math.floor(totalCents / 10);
                    const correctJiao = totalCents % 10;

                    if (currentState.activeBlankId === 'mix-yuan-2') {
                        if (val === correctYuan) isCorrect = true;
                    } else if (currentState.activeBlankId === 'mix-jiao-2') {
                        if (val === correctJiao) isCorrect = true;
                    }
                }
            }

            const feedbackEl = document.getElementById('feedback-msg');

            if (isCorrect) {
                feedbackEl.innerText = "ç­”å°äº†ï¼ğŸ‘";
                feedbackEl.className = "text-center h-8 mt-1 font-bold text-lg text-green-600";
                handleCorrectTransition();
            } else {
                feedbackEl.innerText = "å†è©¦ä¸€æ¬¡ï¼";
                feedbackEl.className = "text-center h-8 mt-1 font-bold text-lg text-red-500 animate-pulse";
            }
        }

        function handleCorrectTransition() {
            // å°‡ç•¶å‰æ­£ç¢ºçš„æ¡†é–å®šä¸¦æ¨™è¨˜ç¶ è‰²
            const currentId = currentState.activeBlankId;
            if (currentId) {
                const el = document.getElementById(currentId);
                el.classList.remove('active');
                el.classList.add('correct');
                currentState.activeBlankId = null; 
            }

            // å–®ä¸€æ¨¡å¼ç‹€æ…‹è½‰ç§»
            if (currentState.mode !== 'mixed') {
                const totalCents = Math.round(currentState.noteCount * currentState.mode * 10);
                
                if (currentState.phase === PHASES.SIMPLE) {
                    finishQuestion();
                } else if (currentState.phase === PHASES.CENT_TOTAL) {
                    if (totalCents >= 10) {
                        currentState.phase = PHASES.CENT_CONVERT_YUAN;
                        renderSentence(); 
                    } else {
                        finishQuestion();
                    }
                } else if (currentState.phase === PHASES.CENT_CONVERT_YUAN) {
                    currentState.phase = PHASES.CENT_CONVERT_CENT;
                    renderSentence(); 
                } else if (currentState.phase === PHASES.CENT_CONVERT_CENT) {
                    finishQuestion();
                }
            }
            // æ··åˆæ¨¡å¼ç‹€æ…‹è½‰ç§» (åºåˆ—å¼ï¼šå…ƒ -> è§’)
            else {
                if (currentState.phase === PHASES.MIXED_PHASE_1) {
                    if (currentId === 'mix-yuan') {
                        // å…ƒç­”å°äº†ï¼Œè§£é–è§’
                        const jiaoEl = document.getElementById('mix-jiao');
                        if (jiaoEl) {
                            jiaoEl.classList.remove('disabled');
                            activateBlank('mix-jiao');
                        }
                    } else if (currentId === 'mix-jiao') {
                        // è§’ä¹Ÿç­”å°äº†ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦é€²ä½
                        if (currentState.targetJiao >= 10) {
                            currentState.phase = PHASES.MIXED_PHASE_2;
                            setTimeout(() => renderSentenceMixed(), 500); 
                        } else {
                            finishQuestion();
                        }
                    }
                } else if (currentState.phase === PHASES.MIXED_PHASE_2) {
                    if (currentId === 'mix-yuan-2') {
                        // æ›ç®—å…ƒç­”å°ï¼Œè§£é–æ›ç®—è§’
                        const jiao2El = document.getElementById('mix-jiao-2');
                        if (jiao2El) {
                            jiao2El.classList.remove('disabled');
                            activateBlank('mix-jiao-2');
                        }
                    } else if (currentId === 'mix-jiao-2') {
                        // å…¨éƒ¨å®Œæˆ
                        finishQuestion();
                    }
                }
            }
        }

        function finishQuestion() {
            document.getElementById('next-btn').classList.remove('hidden');
        }

        function nextQuestion() {
            if (currentState.currentQueueIndex < currentState.questionQueue.length - 1) {
                currentState.currentQueueIndex++;
                loadQuestion();
            } else {
                showCompletion();
            }
        }

        function showCompletion() {
            document.getElementById('completion-modal').classList.remove('hidden');
        }

        function resetGame() {
            startGame(currentState.mode);
        }

        init();

    </script>
</body>
</html>
