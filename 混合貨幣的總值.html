<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯è²¨å¹£ç¸½å€¼å¤§æŒ‘æˆ° (æ•´åˆç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            user-select: none;
            overflow: hidden;
        }

        /* --- åœ–ç‰‡æ¨£å¼ --- */
        .money-item {
            cursor: pointer;
            transition: transform 0.2s, filter 0.2s;
            position: relative;
        }
        .money-item:hover { transform: scale(1.05); filter: brightness(1.1); }
        .money-item:active { transform: scale(0.95); }

        .banknote-shadow { box-shadow: 0 4px 6px rgba(0,0,0,0.15); border-radius: 4px; }
        .coin-shadow { box-shadow: 0 4px 6px rgba(0,0,0,0.2); border-radius: 50%; }
        
        /* --- å‹•ç•« --- */
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .hint-bubble {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.98);
            color: #16a34a;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 1.1rem;
            border: 2px solid #86efac;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: none;
            z-index: 50;
            white-space: nowrap;
            transform: translate(-50%, -50%);
            max-width: 150%; 
        }

        /* --- å¡«ç©ºé¡Œå°ˆç”¨æ¨£å¼ --- */
        .blank-box {
            display: inline-block;
            min-width: 80px;
            height: 50px;
            line-height: 44px;
            padding: 0 10px;
            margin: 0 6px;
            border: 3px solid #cbd5e1;
            border-radius: 12px;
            background-color: #fff;
            color: #1e3a8a;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-family: monospace;
            vertical-align: middle;
            font-size: 1.75rem;
            font-weight: bold;
        }
        .blank-box:empty::before { content: '?'; color: #cbd5e1; }
        
        .blank-box.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
            transform: scale(1.05);
        }
        
        .blank-box.correct {
            border-color: #22c55e;
            background-color: #f0fdf4;
            color: #15803d;
            cursor: default;
        }
        
        .blank-box.wrong {
            border-color: #ef4444;
            background-color: #fef2f2;
            color: #b91c1c;
            animation: shake 0.4s;
        }

        .blank-box.disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
            border-color: #e2e8f0;
        }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        .keypad-btn {
            background: linear-gradient(to bottom, #ffffff, #f3f4f6);
            border: 1px solid #e5e7eb;
            border-bottom: 4px solid #d1d5db;
            color: #374151;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 12px;
            transition: all 0.1s;
        }
        .keypad-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        .keypad-btn.action-btn { background: #fef3c7; border-color: #fde68a; border-bottom-color: #fcd34d; color: #b45309; }
        .keypad-btn.delete-btn { background: #fee2e2; border-color: #fecaca; border-bottom-color: #fca5a5; color: #b91c1c; }

        /* --- Tab æ¨£å¼ --- */
        .game-tab {
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.5;
            border-bottom: 4px solid transparent;
            filter: grayscale(1);
        }
        .game-tab:hover { opacity: 0.8; }
        .game-tab.active-tab {
            opacity: 1;
            border-bottom: 4px solid #2563eb;
            color: #1e40af;
            background-color: #fff;
            filter: grayscale(0);
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-blue-50">

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="bg-white shadow-sm z-10 shrink-0">
        <div class="flex justify-center border-b border-gray-200">
            <div onclick="switchGameCategory('banknote')" id="tab-banknote" class="game-tab active-tab flex-1 text-center px-2 py-3 text-lg font-bold flex items-center justify-center gap-2">
                <i class="fas fa-money-bill-wave text-green-600"></i> <span class="hidden sm:inline">ç´™å¹£æŒ‘æˆ°</span><span class="sm:hidden">ç´™å¹£</span>
            </div>
            <div onclick="switchGameCategory('mixed_all')" id="tab-mixed_all" class="game-tab flex-1 text-center px-2 py-3 text-lg font-bold flex items-center justify-center gap-2">
                <i class="fas fa-layer-group text-purple-600"></i> <span class="hidden sm:inline">æ··åˆæŒ‘æˆ°</span><span class="sm:hidden">æ··åˆ</span>
            </div>
            <div onclick="switchGameCategory('coin')" id="tab-coin" class="game-tab flex-1 text-center px-2 py-3 text-lg font-bold flex items-center justify-center gap-2">
                <i class="fas fa-coins text-yellow-500"></i> <span class="hidden sm:inline">ç¡¬å¹£æŒ‘æˆ°</span><span class="sm:hidden">ç¡¬å¹£</span>
            </div>
        </div>

        <div class="max-w-6xl mx-auto relative flex flex-col items-center p-2 w-full">
            <button id="random-btn" onclick="toggleRandomMode()" class="absolute right-2 top-2 px-3 py-1 rounded-full shadow-sm text-sm font-bold transition-all bg-gray-100 text-gray-500 hover:bg-gray-200 z-20">
                <i class="fas fa-random mr-1"></i> éš¨æ©Ÿï¼šé—œ
            </button>
            <div class="flex flex-wrap justify-center gap-2 mt-1 w-full px-2" id="mode-buttons"></div>
        </div>
    </header>

    <!-- éŠæˆ²ä¸»å€åŸŸ -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- å·¦æ–¹ï¼šé¡Œç›®å€ -->
        <div class="w-full md:w-2/3 flex flex-col relative h-full">
            <!-- é€²åº¦æ¢ -->
            <div class="flex justify-between items-center p-4 px-6 shrink-0">
                <div class="bg-white px-4 py-1 rounded-full shadow-sm text-blue-600 font-bold border border-blue-100">
                    é¡Œç›®ï¼š<span id="progress-display">1 / 10</span>
                </div>
                <div class="text-gray-500 font-bold text-sm md:text-base flex items-center">
                    <i class="fas fa-hand-pointer mr-2 animate-bounce"></i> <span id="instr-text">é»æ“ŠéŒ¢å¹£æŸ¥çœ‹æç¤º</span>
                </div>
            </div>

            <!-- éŒ¢å¹£é¡¯ç¤ºå€ -->
            <div class="flex-1 overflow-y-auto flex justify-center items-start p-4 custom-scrollbar">
                <div id="items-area" class="grid w-full max-w-5xl gap-4 auto-rows-min transition-all duration-300">
                    <!-- Javascript ç”Ÿæˆå…§å®¹ -->
                </div>
            </div>

            <!-- å¥å­é¡¯ç¤ºå€ (ä½œç­”å€) -->
            <div class="shrink-0 w-full bg-white/60 backdrop-blur-sm p-4 border-t border-blue-100 flex flex-col items-center justify-center min-h-[160px]">
                <div id="result-sentence" class="text-xl md:text-3xl font-bold text-blue-900 mb-2 bg-white px-8 py-6 rounded-2xl shadow-sm border border-blue-200 text-center w-full max-w-4xl flex flex-col items-center justify-center gap-2">
                    <!-- å¡«ç©ºé¡Œå…§å®¹ -->
                </div>
                
                <button id="next-btn" onclick="nextQuestion()" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-12 rounded-full text-xl shadow-lg transform transition hover:scale-105 flex items-center gap-2 mt-2 animate-bounce">
                    ä¸‹ä¸€é¡Œ <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- å³æ–¹ï¼šéµç›¤å€ -->
        <div class="w-full md:w-1/3 bg-white border-l border-gray-100 p-4 flex flex-col items-center justify-center shadow-lg z-20 shrink-0">
            <div class="w-full max-w-xs mb-4 text-center">
                 <div id="instruction-msg" class="text-blue-600 font-bold text-lg">è«‹åœ¨å·¦æ–¹ç©ºæ ¼è¼¸å…¥æ•¸å­—</div>
                 <div id="feedback-msg" class="h-6 text-red-500 font-bold text-lg mt-1"></div>
            </div>

            <!-- æ•¸å­—éµç›¤ -->
            <div class="grid grid-cols-3 gap-3 w-full max-w-[280px]">
                <button class="keypad-btn py-4" onclick="appendNumber('1')">1</button>
                <button class="keypad-btn py-4" onclick="appendNumber('2')">2</button>
                <button class="keypad-btn py-4" onclick="appendNumber('3')">3</button>
                
                <button class="keypad-btn py-4" onclick="appendNumber('4')">4</button>
                <button class="keypad-btn py-4" onclick="appendNumber('5')">5</button>
                <button class="keypad-btn py-4" onclick="appendNumber('6')">6</button>
                
                <button class="keypad-btn py-4" onclick="appendNumber('7')">7</button>
                <button class="keypad-btn py-4" onclick="appendNumber('8')">8</button>
                <button class="keypad-btn py-4" onclick="appendNumber('9')">9</button>
                
                <button class="keypad-btn delete-btn py-4" onclick="deleteNumber()"><i class="fas fa-backspace"></i></button>
                <button class="keypad-btn py-4" onclick="appendNumber('0')">0</button>
                <button class="keypad-btn action-btn py-4" onclick="clearInput()">C</button>
            </div>
        </div>
    </main>

    <!-- å®Œæˆç•«é¢ -->
    <div id="completion-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-md mx-4 animate-bounce-in border-8 border-yellow-300">
            <div class="text-8xl mb-6">ğŸ†</div>
            <h2 class="text-3xl font-bold text-blue-900 mb-4">æŒ‘æˆ°æˆåŠŸï¼</h2>
            <p id="completion-msg" class="text-gray-600 mb-8 text-xl">ä½ çœŸæ˜¯å¤ªæ£’äº†ï¼</p>
            <button onclick="resetGame()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-xl text-xl shadow-xl transition transform hover:scale-105">
                å†ç©ä¸€æ¬¡
            </button>
        </div>
    </div>

    <script>
        // ================= 1. é…ç½®æ•¸æ“š (Config) =================
        const CONFIG = {
            banknote: {
                modes: [10, 20, 50, 100, 500, 1000, 'mixed'],
                images: {
                    10: "https://upload.wikimedia.org/wikipedia/zh/b/b0/HKSAR_hkd10_2007_f.jpg",
                    20: "https://www.bochk.com/dam/bochk/desktop/top/aboutus/banknote/2018/img/bochk_hkd20-back.png",
                    50: "https://www.bochk.com/dam/bochk/desktop/top/aboutus/banknote/2018/img/bochk_hkd50-back.png",
                    100: "https://www.bochk.com/dam/bochk/desktop/top/aboutus/banknote/2018/img/bochk_hkd100-back.png",
                    500: "https://www.bochk.com/dam/bochk/desktop/top/aboutus/banknote/2018/img/bochk_hkd500-back.png",
                    1000: "https://www.bochk.com/dam/bochk/desktop/top/aboutus/banknote/2018/img/bochk_hkd1000-back.png"
                },
                mixPool: [1000, 500, 100, 50, 20, 10]
            },
            coin: {
                modes: [0.1, 0.2, 0.5, 1, 2, 5, 10, 'mixed'],
                images: {
                    0.1: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/1è§’æ­£é¢.png",
                    0.2: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/2è§’æ­£é¢.png",
                    0.5: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/5è§’æ­£é¢.png",
                    1: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/1å…ƒæ­£é¢.png",
                    2: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/2å…ƒæ­£é¢.png",
                    5: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/5å…ƒæ­£é¢.png",
                    10: "https://raw.githubusercontent.com/margaret0209/mathgame/refs/heads/main/10å…ƒæ­£é¢.png"
                },
                mixPool: [10, 5, 2, 1, 0.5, 0.2, 0.1]
            },
            mixed_all: {
                modes: ['challenge'],
                pool: [
                    {val: 1000, type: 'banknote'}, {val: 500, type: 'banknote'}, 
                    {val: 100, type: 'banknote'}, {val: 50, type: 'banknote'}, 
                    {val: 20, type: 'banknote'}, {val: 10, type: 'banknote'},
                    {val: 10, type: 'coin'}, {val: 5, type: 'coin'}, 
                    {val: 2, type: 'coin'}, {val: 1, type: 'coin'}, 
                    {val: 0.5, type: 'coin'}, {val: 0.2, type: 'coin'}, 
                    {val: 0.1, type: 'coin'}
                ]
            }
        };

        const PHASES = {
            SIMPLE: 'simple',         // ç¸½å€¼æ˜¯ ( ? ) å…ƒ
            CENT_TOTAL: 'cent_total', // ç¸½å€¼æ˜¯ ( ? ) è§’
            CONVERT: 'convert',       // ç¸½å€¼æ˜¯ ( ? ) å…ƒ ( ? ) è§’
            MIXED_COIN: 'mixed_coin'  // ç¡¬å¹£æ··åˆæ¨¡å¼å°ˆç”¨
        };

        // ================= 2. å…¨å±€ç‹€æ…‹ (State) =================
        let state = {
            category: 'banknote',
            mode: 10,
            isRandomMode: false,
            queue: [],
            queueIndex: 0,
            
            // ç•¶å‰é¡Œç›®æ•¸æ“š
            currentItems: [], // é¡¯ç¤ºç”¨çš„é™£åˆ—
            sortedItems: [],  // ç”¨æ–¼é©—è­‰é †åºçš„æ­£ç¢ºç­”æ¡ˆé™£åˆ—
            
            // äº’å‹•ç‹€æ…‹
            hintsRevealed: [], // è¨˜éŒ„å“ªäº›å·²ç¶“é»é
            clickedIndex: 0,   // ç•¶å‰å¿…é ˆé»æ“Šçš„ç´¢å¼• (ç”¨æ–¼å¼·åˆ¶é †åº)
            activeBlankId: null,
            phase: null,
            step: 0, // 0=åˆå§‹, 1=å·²ç­”è§’/æ›ç®—å‰é¡¯ç¤º, 2=å…¨éƒ¨å®Œæˆ
            
            // æç¤ºç´¯åŠ å™¨
            hintAccumYuan: 0,
            hintAccumJiao: 0,
            hintAccumTotalJiao: 0 // ç´”è§’æ¨¡å¼å°ˆç”¨ç´¯åŠ å™¨
        };

        // ================= 3. åˆå§‹åŒ–èˆ‡åˆ‡æ› =================
        function init() {
            switchGameCategory('banknote');
        }

        function switchGameCategory(cat) {
            state.category = cat;
            
            document.querySelectorAll('.game-tab').forEach(el => el.classList.remove('active-tab'));
            document.getElementById(`tab-${cat}`).classList.add('active-tab');

            const itemsArea = document.getElementById('items-area');
            if (cat === 'banknote') {
                state.mode = 10;
                itemsArea.className = "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full p-2 auto-rows-min justify-items-center";
            } else if (cat === 'mixed_all') {
                state.mode = 'challenge';
                itemsArea.className = "grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 w-full p-2 auto-rows-min justify-items-center";
            } else {
                state.mode = 1;
                itemsArea.className = "grid grid-cols-3 md:grid-cols-5 gap-4 w-full p-2 auto-rows-min justify-items-center";
            }

            renderModeButtons();
            startGame(state.mode);
        }

        function renderModeButtons() {
            const container = document.getElementById('mode-buttons');
            container.innerHTML = '';
            
            if (state.category === 'mixed_all') {
                const badge = document.createElement('div');
                badge.className = "px-4 py-1.5 rounded-lg border-2 font-bold text-sm bg-purple-100 text-purple-700 border-purple-300 shadow-sm";
                badge.innerText = "åŒ…å«æ‰€æœ‰ç´™å¹£èˆ‡ç¡¬å¹£ (8-15å€‹)";
                container.appendChild(badge);
                return;
            }

            const modes = CONFIG[state.category].modes;
            modes.forEach(m => {
                const btn = document.createElement('button');
                let label = "";
                
                if (m === 'mixed') label = "æ··åˆ";
                else if (state.category === 'coin' && m < 1) label = (m * 10) + "è§’";
                else label = `$${m}`;

                btn.className = `px-3 py-1.5 rounded-lg border-2 font-bold text-sm md:text-base transition-all duration-200 min-w-[3.5rem]
                    ${state.mode === m 
                        ? 'bg-blue-600 text-white border-blue-600 shadow-md transform scale-105' 
                        : 'bg-white text-gray-500 border-gray-200 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-600'}`;
                
                btn.onclick = () => startGame(m);
                btn.innerText = label;
                container.appendChild(btn);
            });
        }

        function toggleRandomMode() {
            state.isRandomMode = !state.isRandomMode;
            const btn = document.getElementById('random-btn');
            if (state.isRandomMode) {
                btn.innerHTML = '<i class="fas fa-random mr-1"></i> éš¨æ©Ÿï¼šé–‹';
                btn.className = "absolute right-2 top-2 px-3 py-1 rounded-full shadow text-sm font-bold transition-all bg-purple-500 text-white hover:bg-purple-600 z-20";
            } else {
                btn.innerHTML = '<i class="fas fa-random mr-1"></i> éš¨æ©Ÿï¼šé—œ';
                btn.className = "absolute right-2 top-2 px-3 py-1 rounded-full shadow-sm text-sm font-bold transition-all bg-gray-100 text-gray-500 hover:bg-gray-200 z-20";
            }
            startGame(state.mode);
        }

        // ================= 4. éŠæˆ²æµç¨‹æ§åˆ¶ =================
        function startGame(mode) {
            state.mode = mode;
            state.queueIndex = 0;
            state.queue = [];
            renderModeButtons();
            document.getElementById('completion-modal').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');

            for (let i = 0; i < 10; i++) {
                state.queue.push(generateQuestion(mode));
            }

            loadQuestion();
        }

        function generateQuestion(mode) {
            let items = [];
            let total = 0;
            let currentMode = mode;

            // --- æ··åˆæŒ‘æˆ° (Mixed All - ç´™å¹£+ç¡¬å¹£) ---
            if (state.category === 'mixed_all') {
                const count = Math.floor(Math.random() * 8) + 8;
                const pool = CONFIG.mixed_all.pool;
                for(let j=0; j<count; j++) {
                    items.push(pool[Math.floor(Math.random() * pool.length)]);
                }
                items.sort((a, b) => b.val - a.val);
                total = items.reduce((acc, cur) => acc + cur.val, 0);
                total = Math.round(total * 10) / 10;
                
                // [é—œéµä¿®æ”¹] æ··åˆæŒ‘æˆ°ç¾åœ¨ä½¿ç”¨ MIXED_COIN é‚è¼¯ (å…ˆç®—æœªé€²ä½ç¸½é¡ï¼Œå†ç®—æ›ç®—)
                // isCoinMixed è¨­ç‚º true å•Ÿå‹•é †åºé»æ“Š
                return { items, total, phase: PHASES.MIXED_COIN, isCoinMixed: true };
            }

            // --- ç´™å¹£ ---
            if (state.category === 'banknote') {
                if (currentMode === 'mixed') {
                    const count = Math.floor(Math.random() * 5) + 2; 
                    for (let j = 0; j < count; j++) {
                        items.push(CONFIG.banknote.mixPool[Math.floor(Math.random() * CONFIG.banknote.mixPool.length)]);
                    }
                    items.sort((a, b) => b - a);
                } else {
                    const count = Math.floor(Math.random() * 10) + 1;
                    for (let j = 0; j < count; j++) items.push(currentMode);
                }
                total = items.reduce((a, b) => a + b, 0);
                return { items, total, phase: PHASES.SIMPLE, isCoinMixed: false };
            } 
            
            // --- ç¡¬å¹£ ---
            else {
                // ç¡¬å¹£æ··åˆæ¨¡å¼
                if (currentMode === 'mixed') {
                    let count = 0;
                    if (state.isRandomMode) {
                         // éš¨æ©Ÿæ¨¡å¼: 4-6å€‹
                         count = Math.floor(Math.random() * 3) + 4;
                    } else {
                         // ä¸€èˆ¬æ¨¡å¼: 4-10å€‹
                         count = Math.floor(Math.random() * 7) + 4;
                    }

                    for(let j=0; j<count; j++){
                        items.push(CONFIG.coin.mixPool[Math.floor(Math.random() * CONFIG.coin.mixPool.length)]);
                    }
                    
                    // æ­£ç¢ºç­”æ¡ˆæ°¸é æ˜¯å¾å¤§åˆ°å°
                    items.sort((a,b) => b - a);
                    
                    total = items.reduce((a, b) => a + b, 0);
                    total = Math.round(total * 10) / 10;
                    
                    return { items, total, phase: PHASES.MIXED_COIN, isCoinMixed: true };
                } 
                // å–®ä¸€ç¡¬å¹£æ¨¡å¼
                else {
                    const count = Math.floor(Math.random() * 10) + 1;
                    for (let j = 0; j < count; j++) items.push(currentMode);
                    let phase = PHASES.SIMPLE;
                    if (currentMode < 1) { // è§’å¹£ (0.1, 0.2, 0.5)
                        phase = PHASES.CENT_TOTAL; // è§’å¹£æ¨¡å¼å›ºå®šä½¿ç”¨æ¼¸é€²å¼ (ç¸½è§’ -> å…ƒè§’)
                    }
                    total = items.reduce((a, b) => a + b, 0);
                    total = Math.round(total * 10) / 10;
                    return { items, total, phase, isCoinMixed: false };
                }
            }
        }

        function loadQuestion() {
            const q = state.queue[state.queueIndex];
            
            // è¤‡è£½ items ç”¨æ–¼é¡¯ç¤º
            state.sortedItems = [...q.items]; // ä¿å­˜æ­£ç¢ºé †åº (å¤§->å°)
            
            if (q.isCoinMixed && state.isRandomMode) {
                // éš¨æ©Ÿæ‰“äº‚é¡¯ç¤º
                state.currentItems = [...q.items].sort(() => Math.random() - 0.5);
            } else {
                state.currentItems = [...q.items];
            }

            state.hintsRevealed = new Array(state.currentItems.length).fill(false);
            
            state.hintAccumYuan = 0;
            state.hintAccumJiao = 0;
            state.hintAccumTotalJiao = 0; // é‡ç½®ç´”è§’ç´¯åŠ 
            state.phase = q.phase;
            state.step = 0; 
            state.clickedIndex = 0; // é‡ç½®é»æ“Šé€²åº¦

            document.getElementById('progress-display').innerText = `${state.queueIndex + 1} / 10`;
            document.getElementById('next-btn').classList.add('hidden');
            
            // æŒ‡å¼•æ–‡å­—
            const instr = document.getElementById('instr-text');
            if (q.isCoinMixed) {
                instr.innerText = state.isRandomMode ? "è«‹ç”±å¤§è‡³å°é»æ“Šç¡¬å¹£" : "è«‹ç”±å·¦è‡³å³é»æ“Šç¡¬å¹£";
            } else {
                instr.innerText = "é»æ“ŠéŒ¢å¹£æŸ¥çœ‹æç¤º";
            }
            
            document.getElementById('instruction-msg').innerText = "è«‹åœ¨å·¦æ–¹ç©ºæ ¼è¼¸å…¥æ•¸å­—";
            document.getElementById('instruction-msg').className = "text-blue-600 font-bold text-lg";
            document.getElementById('feedback-msg').innerText = "";
            
            renderQuestionSentence(q);
            renderItems();
        }

        function renderItems() {
            const area = document.getElementById('items-area');
            area.innerHTML = '';
            
            state.currentItems.forEach((itemData, idx) => {
                // åŒ…è£¹å±¤ï¼Œç”¨æ–¼ç›¸å°å®šä½æç¤ºæ°£æ³¡
                const wrapper = document.createElement('div');
                wrapper.className = "relative flex justify-center items-center";

                const img = document.createElement('img');
                let val, type;

                if (typeof itemData === 'object') {
                    val = itemData.val;
                    type = itemData.type;
                } else {
                    val = itemData;
                    type = state.category;
                }

                if (type === 'banknote') {
                    img.src = CONFIG.banknote.images[val];
                    img.className = "money-item banknote-img banknote-shadow pop-in w-full";
                } else {
                    img.src = CONFIG.coin.images[val];
                    img.className = "money-item money-img coin-shadow pop-in";
                    // ç¢ºä¿ç¡¬å¹£æœ‰è¶³å¤ å¯¬åº¦
                    img.style.width = "80%";
                    img.style.maxWidth = "110px";
                }
                img.style.animationDelay = `${idx * 0.05}s`;
                
                // å‚³å…¥å€¼å’Œç•¶å‰é¡¯ç¤ºçš„ç´¢å¼•
                img.onclick = (e) => handleItemClick(e, val, idx);
                
                wrapper.appendChild(img);
                area.appendChild(wrapper);
            });
        }

        // ================= 5. å¡«ç©ºé¡Œæ¸²æŸ“èˆ‡é‚è¼¯ =================
        function renderQuestionSentence(q) {
            const container = document.getElementById('result-sentence');
            container.innerHTML = '';
            
            let html = '';
            const total = q.total;
            const yuan = Math.floor(total);
            const jiao = Math.round((total - yuan) * 10);
            const totalJiao = Math.round(total * 10);

            // --- æ··åˆç¡¬å¹£/æ··åˆæŒ‘æˆ° æ¨¡å¼ ---
            if (q.phase === PHASES.MIXED_COIN) {
                // ç¬¬ä¸€éšæ®µï¼šRaw å…ƒ / è§’
                let rawYuan = 0;
                let rawJiao = 0;
                q.items.forEach(v => {
                    let vv = (typeof v === 'object') ? v.val : v;
                    if (vv >= 1) rawYuan += vv;
                    else rawJiao += Math.round(vv * 10);
                });

                // ç¬¬ä¸€è¡Œ
                let line1 = "";
                if (state.step === 0) {
                    line1 = `ç¸½å€¼æ˜¯ <span id="blank-raw-yuan" class="blank-box" onclick="activateBlank('blank-raw-yuan')" data-ans="${rawYuan}"></span> å…ƒ 
                             <span id="blank-raw-jiao" class="blank-box disabled" onclick="activateBlank('blank-raw-jiao')" data-ans="${rawJiao}"></span> è§’`;
                    state.activeBlankId = 'blank-raw-yuan';
                } else {
                    line1 = `ç¸½å€¼æ˜¯ <span class="blank-box correct" style="cursor:default">${rawYuan}</span> å…ƒ 
                             <span class="blank-box correct" style="cursor:default">${rawJiao}</span> è§’`;
                }
                html += `<div>${line1}</div>`;

                // ç¬¬äºŒè¡Œï¼šå¦‚æœè§’ >= 10ï¼Œé¡¯ç¤ºæ›ç®—
                if (state.step >= 1 && rawJiao >= 10) {
                     let line2 = "";
                     if (state.step === 2) {
                         // å…¨éƒ¨å®Œæˆï¼Œè½‰éœæ…‹
                         line2 = `çš„ç¸½å€¼ <span class="blank-box correct" style="cursor:default">${yuan}</span> å…ƒ <span class="blank-box correct" style="cursor:default">${jiao}</span> è§’`;
                     } else {
                         // è¼¸å…¥ç‹€æ…‹
                         line2 = `çš„ç¸½å€¼ <span id="blank-yuan" class="blank-box" onclick="activateBlank('blank-yuan')" data-ans="${yuan}"></span> å…ƒ 
                                  <span id="blank-jiao" class="blank-box disabled" onclick="activateBlank('blank-jiao')" data-ans="${jiao}"></span> è§’`;
                     }
                     html += `<div class="mt-4 pt-4 border-t-2 border-dashed border-blue-200 w-full animate-bounce-in">${line2}</div>`;
                }
            }
            // --- è§’å¹£å°ˆç”¨ (CENT_TOTAL) ---
            else if (q.phase === PHASES.CENT_TOTAL) {
                let line1 = "";
                if (state.step === 0) {
                    line1 = `ç¸½å€¼æ˜¯ <span id="blank-total" class="blank-box" onclick="activateBlank('blank-total')" data-ans="${totalJiao}"></span> è§’`;
                    state.activeBlankId = 'blank-total';
                } else {
                    line1 = `ç¸½å€¼æ˜¯ <span class="blank-box correct" style="cursor:default">${totalJiao}</span> è§’`;
                }
                html += `<div>${line1}</div>`;

                // åªæœ‰ç•¶ç¸½å€¼ >= 10è§’ æ™‚æ‰é¡¯ç¤ºç¬¬äºŒè¡Œæ›ç®—
                if (state.step >= 1 && total >= 1) {
                    let line2 = "";
                    if (state.step === 2) {
                        line2 = `ç¸½å€¼æ˜¯ <span class="blank-box correct" style="cursor:default">${yuan}</span> å…ƒ <span class="blank-box correct" style="cursor:default">${jiao}</span> è§’`;
                    } else {
                        line2 = `ç¸½å€¼æ˜¯ <span id="blank-yuan" class="blank-box" onclick="activateBlank('blank-yuan')" data-ans="${yuan}"></span> å…ƒ 
                                 <span id="blank-jiao" class="blank-box disabled" onclick="activateBlank('blank-jiao')" data-ans="${jiao}"></span> è§’`;
                    }
                    html += `<div class="mt-4 pt-4 border-t-2 border-dashed border-blue-200 w-full animate-bounce-in">${line2}</div>`;
                }
            }
            // --- ä¸€èˆ¬å–®ä¸€ç¡¬å¹£/ç´™å¹£/æ··åˆæŒ‘æˆ°æ¨¡å¼ ---
            else if (q.phase === PHASES.SIMPLE) {
                html = `<div>ç¸½å€¼æ˜¯ <span id="blank-total" class="blank-box" onclick="activateBlank('blank-total')" data-ans="${total}"></span> å…ƒ</div>`;
                state.activeBlankId = 'blank-total';
            } 
            else if (q.phase === PHASES.CONVERT) {
                html = `<div>ç¸½å€¼æ˜¯ 
                    <span id="blank-yuan" class="blank-box" onclick="activateBlank('blank-yuan')" data-ans="${yuan}"></span> å…ƒ 
                    <span id="blank-jiao" class="blank-box disabled" onclick="activateBlank('blank-jiao')" data-ans="${jiao}"></span> è§’</div>`;
                state.activeBlankId = 'blank-yuan';
            }

            container.innerHTML = html;
            updateBlankStyle();
        }

        function updateBlankStyle() {
            document.querySelectorAll('.blank-box').forEach(el => {
                if (el.id === state.activeBlankId) el.classList.add('active');
                else el.classList.remove('active');
            });
        }

        function activateBlank(id) {
            const el = document.getElementById(id);
            if (el && !el.classList.contains('disabled') && !el.classList.contains('correct')) {
                state.activeBlankId = id;
                updateBlankStyle();
                el.innerText = ''; 
                document.getElementById('feedback-msg').innerText = "";
            }
        }

        // ================= 6. éµç›¤è¼¸å…¥èˆ‡è‡ªå‹•æ ¸å° =================
        function appendNumber(num) {
            const el = document.getElementById(state.activeBlankId);
            if (!el) return;

            const targetAns = el.dataset.ans;
            let currentVal = el.innerText;
            
            if (currentVal === '?' || currentVal === '') {
                currentVal = num;
            } else {
                currentVal += num;
            }

            if (currentVal.length > targetAns.length) {
                currentVal = num;
            }

            el.innerText = currentVal;
            
            if (currentVal.length === targetAns.length) {
                checkAnswer(el, currentVal, targetAns);
            }
        }

        function checkAnswer(el, inputVal, correctVal) {
            if (inputVal === correctVal) {
                // --- ç­”å° ---
                el.classList.remove('active');
                el.classList.add('correct');
                playSuccessSound();

                // è™•ç†é‚è¼¯æµç¨‹
                const q = state.queue[state.queueIndex];

                // Case: Mixed Coin & Mixed All (Raw -> Converted)
                if (state.phase === PHASES.MIXED_COIN) {
                    if (el.id === 'blank-raw-yuan') {
                         const rawJiaoEl = document.getElementById('blank-raw-jiao');
                         rawJiaoEl.classList.remove('disabled');
                         activateBlank('blank-raw-jiao');
                    } else if (el.id === 'blank-raw-jiao') {
                        let rawJiao = 0;
                        q.items.forEach(v => { 
                            let vv = (typeof v === 'object') ? v.val : v;
                            if (vv < 1) rawJiao += Math.round(vv * 10); 
                        });
                        
                        if (rawJiao >= 10) {
                            state.step = 1;
                            renderQuestionSentence(q);
                            activateBlank('blank-yuan');
                        } else {
                            finishQuestion();
                        }
                    } else if (el.id === 'blank-yuan') {
                        const jiaoEl = document.getElementById('blank-jiao');
                        jiaoEl.classList.remove('disabled');
                        activateBlank('blank-jiao');
                    } else if (el.id === 'blank-jiao') {
                        state.step = 2; // å®Œæˆ
                        renderQuestionSentence(q);
                        finishQuestion();
                    }
                }
                // Case: Cent Total (Total -> Converted)
                else if (state.phase === PHASES.CENT_TOTAL && el.id === 'blank-total') {
                    if (q.total >= 1) {
                        state.step = 1; // é€²å…¥ç¬¬äºŒè¡Œè¼¸å…¥éšæ®µ
                        renderQuestionSentence(q);
                        activateBlank('blank-yuan');
                    } else {
                        finishQuestion();
                    }
                }
                else if (state.phase === PHASES.CENT_TOTAL && el.id === 'blank-yuan') {
                    const jiaoEl = document.getElementById('blank-jiao');
                    if (jiaoEl) {
                         jiaoEl.classList.remove('disabled');
                         activateBlank('blank-jiao');
                    }
                }
                else if (state.phase === PHASES.CENT_TOTAL && el.id === 'blank-jiao') {
                    state.step = 2; // å…¨éƒ¨å®Œæˆ
                    renderQuestionSentence(q);
                    finishQuestion();
                }
                // Case: Normal Convert
                else if (el.id === 'blank-yuan') {
                    const jiaoEl = document.getElementById('blank-jiao');
                    if (jiaoEl) {
                        jiaoEl.classList.remove('disabled');
                        activateBlank('blank-jiao');
                    } else {
                        finishQuestion();
                    }
                } else {
                    finishQuestion();
                }
            } else {
                // --- ç­”éŒ¯ ---
                el.classList.add('wrong');
                document.getElementById('feedback-msg').innerText = "å†è©¦ä¸€æ¬¡ï¼";
                setTimeout(() => {
                    el.classList.remove('wrong');
                    el.innerText = "";
                }, 500);
            }
        }

        function deleteNumber() {
            const el = document.getElementById(state.activeBlankId);
            if (el) el.innerText = '';
        }

        function clearInput() {
            const el = document.getElementById(state.activeBlankId);
            if (el) el.innerText = '';
        }

        function finishQuestion() {
            document.getElementById('instruction-msg').innerText = "ç­”å°äº†ï¼";
            document.getElementById('instruction-msg').className = "text-green-600 font-bold text-2xl animate-bounce";
            document.getElementById('feedback-msg').innerText = "";
            document.getElementById('next-btn').classList.remove('hidden');
            
            const items = document.getElementById('items-area').children;
            for(let item of items) {
                // item is the wrapper, item.firstChild is the img
                if(item.firstChild) item.firstChild.classList.add('shake');
            }
        }

        function playSuccessSound() {}

        // ================= 7. é»æ“Šèˆ‡æç¤ºé‚è¼¯ (æ ¸å¿ƒä¿®æ”¹) =================
        function handleItemClick(e, val, displayIdx) {
            // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œæ··åˆç¡¬å¹£ã€æˆ–ã€Œæ··åˆæŒ‘æˆ°ã€æ¨¡å¼ (éœ€è¦å¼·åˆ¶é †åº)
            const q = state.queue[state.queueIndex];
            
            if (q.isCoinMixed) {
                if (state.hintsRevealed[displayIdx]) return; // å·²é»é

                // å°æ¯”ï¼šå¦‚æœæ˜¯ Object {val, type} å– valï¼Œå¦‚æœæ˜¯ç´”æ•¸å­—å–æ•¸å­—
                const targetObj = state.sortedItems[state.clickedIndex];
                const targetVal = (typeof targetObj === 'object') ? targetObj.val : targetObj;
                
                // å®¹éŒ¯ï¼šæµ®é»æ•¸æ¯”è¼ƒ
                const isCorrect = Math.abs(val - targetVal) < 0.001;
                
                if (isCorrect) {
                    // é»å°äº†
                    state.clickedIndex++;
                    showHint(e, val, displayIdx, true); // true = æ··åˆæ¨¡å¼ç‰¹æ®Šé¡¯ç¤º
                } else {
                    // é»éŒ¯äº† -> éœ‡å‹•æç¤º
                    e.target.classList.remove('shake');
                    void e.target.offsetWidth; // trigger reflow
                    e.target.classList.add('shake');
                    
                    document.getElementById('feedback-msg').innerText = "è«‹ç”±å¤§è‡³å°é»æ“Šï¼";
                    setTimeout(() => document.getElementById('feedback-msg').innerText = "", 1000);
                }

            } else {
                // å…¶ä»–æ¨¡å¼ï¼šéš¨æ„é»æ“Š
                showHint(e, val, displayIdx, false);
            }
        }

        function showHint(e, val, idx, isMixedMode) {
            if (state.hintsRevealed[idx]) return;
            state.hintsRevealed[idx] = true;

            let hintText = "";
            const isCentMode = [0.1, 0.2, 0.5].includes(state.mode); // åˆ¤æ–·æ˜¯å¦ç‚º 1,2,5è§’ æ¨¡å¼

            if (isMixedMode) {
                if (val >= 1) {
                    state.hintAccumYuan += val;
                    hintText = `${state.hintAccumYuan}å…ƒ`;
                } else {
                    state.hintAccumJiao = Math.round((state.hintAccumJiao + (val * 10)) * 10) / 10;
                    hintText = `${state.hintAccumJiao}è§’`;
                }
            } else if (isCentMode) {
                // ç´”è§’å¹£æ¨¡å¼ï¼šåªç´¯åŠ è§’ï¼Œä¸æ›ç®—æˆå…ƒ
                let valInJiao = Math.round(val * 10);
                state.hintAccumTotalJiao += valInJiao;
                hintText = `${state.hintAccumTotalJiao}è§’`;
            } else {
                let valInJiao = Math.round(val * 10);
                let totalJiao = (state.hintAccumYuan * 10) + state.hintAccumJiao + valInJiao;

                state.hintAccumYuan = Math.floor(totalJiao / 10);
                state.hintAccumJiao = totalJiao % 10;

                if (state.hintAccumYuan > 0) hintText += `${state.hintAccumYuan}å…ƒ`;
                if (state.hintAccumJiao > 0) hintText += `${state.hintAccumJiao}è§’`;
                if (hintText === "") hintText = "0å…ƒ";
            }

            const img = e.target;
            const wrapper = img.parentElement; // ç²å–åŒ…è£¹å±¤

            const bubble = document.createElement('div');
            bubble.className = 'hint-bubble pop-in';
            bubble.innerText = hintText;
            
            // ç›¸å°å®šä½æ–¼çˆ¶å®¹å™¨ (wrapper)
            bubble.style.left = '50%';
            bubble.style.top = '50%';
            
            wrapper.appendChild(bubble);

            img.style.filter = "grayscale(100%) opacity(0.6)";

            // ç§»é™¤è¨ˆæ™‚å™¨ï¼Œè®“æ°£æ³¡ä¿ç•™
        }

        // ================= 8. ä¸‹ä¸€é¡Œèˆ‡çµç®— =================
        function nextQuestion() {
            if (state.queueIndex < state.queue.length - 1) {
                state.queueIndex++;
                loadQuestion();
            } else {
                showCompletion();
            }
        }

        function showCompletion() {
            document.getElementById('completion-modal').classList.remove('hidden');
            const msg = document.getElementById('completion-msg');
            
            if (state.category === 'mixed_all') {
                msg.innerText = `å¤ªå¼·äº†ï¼ä½ å®Œæˆäº†æ··åˆè²¨å¹£å¤§æŒ‘æˆ°ï¼`;
            } else if (state.category === 'banknote') {
                msg.innerText = `ä½ å®Œæˆäº†ç´™å¹£æŒ‘æˆ°ï¼`;
            } else {
                msg.innerText = `ä½ å®Œæˆäº†ç¡¬å¹£æŒ‘æˆ°ï¼`;
            }
        }

        function resetGame() {
            startGame(state.mode);
        }

        init();

    </script>
</body>
</html>