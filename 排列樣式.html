<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶£å‘³æ¨£å¼æ’åºéŠæˆ²</title>
    <!-- ä½¿ç”¨ Tailwind CSS é€²è¡Œå¿«é€Ÿæ¨£å¼è¨­è¨ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ animate.css å¢åŠ äº’å‹•æ•ˆæœ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            user-select: none; /* é˜²æ­¢é¸å–æ–‡å­—å¹²æ“¾éŠæˆ² */
        }

        .game-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* æç¤ºæ¡†æ¨£å¼ - è™›ç·šæ¡† */
        .hint-box {
            border: 3px dashed #f59e0b; /* Amber 500 */
            background-color: rgba(253, 230, 138, 0.3); /* Amber 200 opacity */
            border-radius: 12px;
            padding: 4px;
            margin: -4px; /* æŠµæ¶ˆ padding ç¢ºä¿ä¸å½±éŸ¿ä½ˆå±€å¤ª */
            position: relative;
            z-index: 0;
            transition: all 0.3s ease;
            /* è®“æ–°å‡ºç¾çš„æ¡†æœ‰æ·¡å…¥æ•ˆæœ */
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* æç¤ºæ–‡å­—æ¨™ç±¤ */
        .hint-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f59e0b;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .hint-box:hover .hint-label, .hint-active .hint-label {
            opacity: 1;
        }

        .item-slot {
            transition: background-color 0.3s, border-color 0.3s;
        }

        .option-btn {
            transition: transform 0.1s, background-color 0.2s;
        }
        .option-btn:active {
            transform: scale(0.95);
        }

        /* æˆåŠŸå‹•ç•« */
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in {
            animation: popIn 0.4s forwards;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="game-card w-full max-w-4xl p-6 flex flex-col gap-6">
        
        <!-- Header & Controls -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 border-b pb-4">
            <h1 class="text-2xl font-bold text-slate-700">ğŸ§© æ¨£å¼æ’åºéŠæˆ²</h1>
            
            <div class="flex flex-wrap gap-3 justify-center">
                <!-- æ¨£å¼é¸æ“‡ -->
                <div class="flex flex-wrap gap-1 bg-slate-100 rounded-lg p-1 justify-center">
                    <button onclick="setPattern('AB')" id="btn-ab" class="px-3 py-1.5 rounded-md text-sm font-bold transition-colors bg-white shadow text-blue-600">AB</button>
                    <button onclick="setPattern('ABC')" id="btn-abc" class="px-3 py-1.5 rounded-md text-sm font-bold transition-colors text-slate-500 hover:bg-slate-200">ABC</button>
                    <button onclick="setPattern('ABA')" id="btn-aba" class="px-3 py-1.5 rounded-md text-sm font-bold transition-colors text-slate-500 hover:bg-slate-200">ABA</button>
                    <button onclick="setPattern('ABB')" id="btn-abb" class="px-3 py-1.5 rounded-md text-sm font-bold transition-colors text-slate-500 hover:bg-slate-200">ABB</button>
                    <button onclick="setPattern('AAB')" id="btn-aab" class="px-3 py-1.5 rounded-md text-sm font-bold transition-colors text-slate-500 hover:bg-slate-200">AAB</button>
                    <button onclick="setPattern('RANDOM')" id="btn-random" class="px-3 py-1.5 rounded-md text-sm font-bold transition-colors text-slate-500 hover:bg-slate-200 border-l border-slate-300 ml-1 pl-3 text-purple-600">ğŸ² éš¨æ©Ÿ</button>
                </div>

                <!-- ä¸»é¡Œé¸æ“‡ -->
                <select id="theme-select" onchange="changeTheme()" class="bg-slate-100 border-none text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    <option value="animals">ğŸ¶ å‹•ç‰©</option>
                    <option value="fruits">ğŸ è”¬æœ</option>
                    <option value="food">ğŸ” é£Ÿç‰©</option>
                    <option value="emotions">ğŸ˜€ è¡¨æƒ…</option>
                    <option value="actions">ğŸƒ å‹•ä½œ</option>
                    <option value="colors">ğŸ¨ é¡è‰²</option>
                </select>

                <!-- æç¤ºé–‹é—œ -->
                <button onclick="toggleHint()" id="btn-hint" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold border-2 border-slate-200 text-slate-500 hover:bg-yellow-50 hover:border-yellow-300 hover:text-yellow-600 transition-all">
                    <span>ğŸ’¡ æç¤ºæ¨¡å¼</span>
                    <span id="hint-status" class="text-xs bg-slate-200 px-2 py-0.5 rounded-full">é—œé–‰</span>
                </button>
            </div>
        </header>

        <!-- Main Game Area -->
        <main class="flex-grow flex flex-col items-center justify-center min-h-[200px] bg-slate-50 rounded-xl border-2 border-slate-100 p-4 relative overflow-hidden">
            
            <!-- Game Status/Message -->
            <div id="game-message" class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-400 text-sm font-medium">
                è§€å¯Ÿè¦å¾‹ï¼Œå¡«å…¥æ­£ç¢ºçš„åœ–æ¡ˆ
            </div>

            <!-- Sequence Track -->
            <div id="sequence-track" class="flex flex-wrap items-center justify-center gap-2 md:gap-4 mt-6 px-2">
                <!-- Items will be injected here by JS -->
            </div>

        </main>

        <!-- Bottom Question Area -->
        <footer class="flex flex-col items-center gap-4 pt-2">
            <h2 class="text-xl font-bold text-slate-700 flex items-center gap-2">
                â“ ä¸‹ä¸€å€‹åœ–æ¡ˆæ˜¯ï¼Ÿ
            </h2>
            
            <div id="options-container" class="flex gap-6 mt-2">
                <!-- Options will be injected here by JS -->
            </div>

            <!-- Next Level Button (Hidden initially) -->
            <button id="next-level-btn" onclick="nextLevel()" class="hidden mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg animate__animated animate__pulse animate__infinite">
                ğŸ‰ å¤ªæ£’äº†ï¼ä¸‹ä¸€é¡Œ â¡ï¸
            </button>
        </footer>

    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Sound System ---
        // ä½¿ç”¨ Web Audio API é¿å…ä¾è³´å¤–éƒ¨æª”æ¡ˆ
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playSound(type) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'correct') {
                // å®ï¼ (é«˜éŸ³æ­£å¼¦æ³¢)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);

            } else if (type === 'wrong') {
                // å—¡... (ä½éŸ³é‹¸é½’æ³¢)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);

            } else if (type === 'click') {
                // å™  (çŸ­ä¿ƒçš„é»æ“ŠéŸ³)
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);

            } else if (type === 'win') {
                // å‹åˆ©å’Œå¼¦ (C Major)
                playNote(523.25, now, 0.1); // C5
                playNote(659.25, now + 0.1, 0.1); // E5
                playNote(783.99, now + 0.2, 0.1); // G5
                playNote(1046.50, now + 0.3, 0.4); // C6
            }
        }

        function playNote(freq, time, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.2, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
            osc.start(time);
            osc.stop(time + duration);
        }

        // --- Game Data ---
        const themes = {
            animals: [
                'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 
                'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸', 'ğŸ’',  
                'ğŸ¦', 'ğŸ¦§', 'ğŸ•', 'ğŸ©', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸˆ', 'ğŸˆâ€â¬›', 'ğŸ…', 'ğŸ†', 
                'ğŸ', 'ğŸ¦„', 'ğŸ¦“', 'ğŸ¦Œ', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ–', 'ğŸ', 
                'ğŸ‘', 'ğŸ', 'ğŸª', 'ğŸ«', 'ğŸ¦™', 'ğŸ¦’', 'ğŸ˜',  'ğŸ¦', 'ğŸ¦›', 
                'ğŸ', 'ğŸ€', 'ğŸ¿', 'ğŸ¦”', 'ğŸ¦¥', 'ğŸ¦¦', 'ğŸ¦¨', 'ğŸ¦˜', 'ğŸ¦¡', 'ğŸ¾', 
                'ğŸ¦ƒ', 'ğŸ”', 'ğŸ“', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ¦…', 
                'ğŸ¦†', 'ğŸ¦¢', 'ğŸ¦‰', 'ğŸ¦©', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸŠ', 'ğŸ¢', 'ğŸ¦', 'ğŸ', 
                'ğŸ²', 'ğŸ‰', 'ğŸ¦•', 'ğŸ¦–', 'ğŸ³', 'ğŸ‹', 'ğŸ¬', 'ğŸŸ', 'ğŸ ', 'ğŸ¡', 
                'ğŸ¦ˆ', 'ğŸ™', 'ğŸš', 'ğŸ¦€', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦‘', 'ğŸ¦ª', 'ğŸŒ', 'ğŸ¦‹', 
                'ğŸ›', 'ğŸœ', 'ğŸ',  'ğŸ', 'ğŸ¦—', 'ğŸ•·', 'ğŸ•¸', 'ğŸ¦‚', 'ğŸ¦Ÿ'
            ],
            fruits: [
                'ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ¥­', 'ğŸ', 'ğŸ', 
                'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ¥', 'ğŸ…', 'ğŸ¥¥', 'ğŸ¥‘', 
                'ğŸ†', 'ğŸ¥”', 'ğŸ¥•', 'ğŸŒ½', 'ğŸ¥’', 'ğŸ¥¬', 'ğŸ¥¦', 'ğŸ§„', 
                'ğŸ§…', 'ğŸ„', 'ğŸ¥œ', 'ğŸŒ°'
            ],
            food: [
                'ğŸ', 'ğŸ¥', 'ğŸ¥–', 'ğŸ¥¨', 'ğŸ¥¯', 'ğŸ¥', 'ğŸ§‡', 'ğŸ§€', 'ğŸ–', 
                'ğŸ—', 'ğŸ¥©', 'ğŸ¥“', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯', 
                'ğŸ¥™', 'ğŸ§†', 'ğŸ¥š', 'ğŸ³', 'ğŸ¥˜', 'ğŸ²', 'ğŸ¥£', 'ğŸ¥—', 
                'ğŸ¿', 'ğŸ§ˆ', 'ğŸ§‚', 'ğŸ¥«', 'ğŸ±', 'ğŸ˜', 'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸœ', 
                'ğŸ', 'ğŸ ', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¥®', 'ğŸ¡', 'ğŸ¥Ÿ', 'ğŸ¥ ',
                'ğŸ¥¡', 'ğŸ¦€', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦‘', 'ğŸ¦ª', 'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©',
                'ğŸª', 'ğŸ‚', 'ğŸ°', 'ğŸ§', 'ğŸ¥§', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯',
                'ğŸ¥›', 'ğŸµ', 'ğŸ§ƒ'
            ],
            emotions: [
                'ğŸ™ˆ', 'ğŸ˜„',
                'ğŸ˜Š', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜˜', 'ğŸ˜—',
                'ğŸ™‰', 'ğŸ¤ª', 'ğŸ¤­', 'ğŸ¤—', 'ğŸ¤­',
                'ğŸ¤«', 'ğŸ¤”', 'ğŸ™„',  'ğŸ¥±',
                'ğŸ˜¬', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’',
                'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜µ', 'ğŸ¥³',
                'ğŸ˜', 'â˜¹ï¸', ''ğŸ˜®â€ğŸ’¨',
                'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜­', 'ğŸ˜±'
            ],
            actions: [
                'ğŸƒ', 'ğŸš¶â€â™€ï¸', 'ğŸ§â€â™€ï¸', 'ğŸ§', 
                'ğŸ§‘â€ğŸ¦¼', 'ğŸ§—â€â™€ï¸', 'ğŸ‡', 'â›·', 'ğŸ‚', 'ğŸŒï¸', 'ğŸ„â€â™€ï¸', 'ğŸš£', 
                'ğŸŠâ€â™€ï¸', 'â›¹ï¸â€â™€ï¸', 'ğŸ‹ï¸', 'ğŸš´', 'ğŸ¤¸â€â™€ï¸', 'ğŸ¤½', 'ğŸ¤¾â€â™€ï¸', 'ğŸ¤¹', 
                'ğŸ’ƒ', 'ğŸ‘ğŸ»', 'ğŸ‘ğŸ»', 'âœŒğŸ»', 'ğŸ‘‹ğŸ»', 'ğŸ’ªğŸ»',
                'ğŸŒğŸ»', 'ğŸ§˜ğŸ»â€â™€ï¸',  'ğŸ¤º', 'ğŸ™†ğŸ»â€â™€ï¸', 
                'ğŸ™…ğŸ»â€â™‚ï¸', 'ğŸ™‹ğŸ»â€â™€ï¸', 'ğŸ¤·ğŸ»â€â™‚ï¸', 'ğŸ¤¦ğŸ»â€â™‚ï¸', 'ğŸ™ŒğŸ»', 'ğŸ‘ŒğŸ»', 'ğŸ‘†ğŸ»', 'ğŸ™ğŸ»', 'ğŸ™‡ğŸ»â€â™€ï¸'
            ],
            colors: ['ğŸ”´', 'ğŸ”µ', 'ğŸŸ¢', 'ğŸŸ¡', 'ğŸŸ£', 'ğŸŸ ', 'âš«', 'âšª']
        };

        const PATTERN_TYPES = ['AB', 'ABC', 'ABA', 'ABB', 'AAB'];

        // --- State Management ---
        let currentState = {
            isRandom: false, // Is Random Mode active?
            patternType: 'AB', // The ACTUAL current pattern being played
            theme: 'animals',
            hintMode: false,
            items: [], 
            sequence: [], 
            visibleCount: 0, 
            userProgress: 0, 
            totalLength: 12
        };

        // --- Initialization ---
        window.onload = () => {
            initGame();
        };

        function initGame() {
            // Hide next button, show options
            document.getElementById('next-level-btn').classList.add('hidden');
            document.getElementById('options-container').classList.remove('hidden');
            document.getElementById('game-message').innerText = "è§€å¯Ÿè¦å¾‹ï¼Œå¡«å…¥æ­£ç¢ºçš„åœ–æ¡ˆ";
            document.getElementById('game-message').className = "absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-400 text-sm font-medium";

            // If in Random Mode, pick a new pattern
            if (currentState.isRandom) {
                const randomIndex = Math.floor(Math.random() * PATTERN_TYPES.length);
                currentState.patternType = PATTERN_TYPES[randomIndex];
            }

            generateSequence();
            renderSequence(); // åˆå§‹æ¸²æŸ“
            renderOptions();
        }

        // --- Core Logic ---

        function generateSequence() {
            const themeItems = themes[currentState.theme];
            const shuffled = [...themeItems].sort(() => 0.5 - Math.random());
            
            const repeatCount = 6;
            let patternTemplate = []; 

            switch (currentState.patternType) {
                case 'AB':
                    currentState.items = [shuffled[0], shuffled[1]];
                    patternTemplate = [0, 1];
                    currentState.visibleCount = Math.random() > 0.5 ? 3 : 4;
                    break;
                case 'ABC':
                    currentState.items = [shuffled[0], shuffled[1], shuffled[2]];
                    patternTemplate = [0, 1, 2];
                    currentState.visibleCount = Math.random() > 0.5 ? 4 : 5;
                    break;
                case 'ABA':
                    currentState.items = [shuffled[0], shuffled[1]];
                    patternTemplate = [0, 1, 0];
                    currentState.visibleCount = Math.random() > 0.5 ? 4 : 5;
                    break;
                case 'ABB':
                    currentState.items = [shuffled[0], shuffled[1]];
                    patternTemplate = [0, 1, 1];
                    currentState.visibleCount = Math.random() > 0.5 ? 4 : 5;
                    break;
                case 'AAB':
                    currentState.items = [shuffled[0], shuffled[1]];
                    patternTemplate = [0, 0, 1];
                    currentState.visibleCount = Math.random() > 0.5 ? 4 : 5;
                    break;
            }

            const unitLength = patternTemplate.length;
            currentState.totalLength = unitLength * repeatCount;

            currentState.sequence = Array.from({length: currentState.totalLength}, (_, i) => {
                return patternTemplate[i % unitLength];
            });

            currentState.userProgress = 0;
        }

        // å…¨é¢æ¸²æŸ“ï¼ˆç”¨æ–¼åˆå§‹åŒ–ã€åˆ‡æ›æç¤ºæˆ–åˆ‡æ›æ¨£å¼ï¼‰
        function renderSequence() {
            const track = document.getElementById('sequence-track');
            track.innerHTML = '';

            const patternLength = (['AB'].includes(currentState.patternType)) ? 2 : 3;
            // è¨­å®šæ¯è¡Œé¡¯ç¤º 3 çµ„è¦å¾‹åœ–æ¡ˆ
            const itemsPerLine = patternLength * 3;
            
            const solvedCount = currentState.visibleCount + currentState.userProgress;
            
            let currentWrapper = null;

            currentState.sequence.forEach((itemIndex, index) => {
                const itemChar = currentState.items[itemIndex];
                const isSolved = index < solvedCount;
                const isNext = index === solvedCount;

                // Hint logic
                const groupIndex = Math.floor(index / patternLength);
                const isGroupStart = (index % patternLength === 0);
                const groupEndIndex = (groupIndex + 1) * patternLength - 1;
                const isGroupFullySolved = solvedCount > groupEndIndex;
                
                const shouldWrap = currentState.hintMode && (groupIndex === 0 || isGroupFullySolved);

                if (isGroupStart) {
                    // æ›è¡Œé‚è¼¯
                    if (index > 0 && index % itemsPerLine === 0) {
                        const breakEl = document.createElement('div');
                        breakEl.className = "w-full basis-full h-4"; 
                        track.appendChild(breakEl);
                    }

                    if (shouldWrap) {
                        currentWrapper = document.createElement('div');
                        currentWrapper.className = 'hint-box flex gap-1 md:gap-2 hint-active items-center justify-center px-2 py-1';
                        if (groupIndex === 0) {
                             currentWrapper.innerHTML = `<span class="hint-label">é‡è¤‡è¦å¾‹</span>`;
                        }
                        track.appendChild(currentWrapper);
                    } else {
                        currentWrapper = null;
                    }
                }

                // Render Item
                const itemEl = document.createElement('div');
                itemEl.id = `slot-${index}`; // çµ¦æ¯å€‹æ ¼å­ä¸€å€‹ç¨ç«‹ ID
                
                // åŸºç¤æ¨£å¼
                itemEl.className = `
                    item-slot w-12 h-12 md:w-16 md:h-16 flex items-center justify-center text-2xl md:text-3xl rounded-xl shadow-sm border-2 flex-shrink-0 transition-all duration-300
                    ${isSolved ? 'bg-white border-slate-200' : (isNext ? 'bg-blue-50 border-blue-300 border-dashed animate-pulse text-blue-400' : 'bg-slate-100 border-slate-200 opacity-50')}
                `;

                if (isSolved) {
                    itemEl.innerText = itemChar;
                    if (index >= currentState.visibleCount) {
                        itemEl.classList.add('pop-in');
                    }
                } else if (isNext) {
                    itemEl.innerText = '?';
                } else {
                    itemEl.innerText = '';
                }

                if (currentWrapper) {
                    currentWrapper.appendChild(itemEl);
                } else {
                    track.appendChild(itemEl);
                }
            });
        }

        // å±€éƒ¨æ›´æ–°ï¼ˆåªæ›´æ–°ç‰¹å®šæ ¼å­ï¼Œé¿å…é–ƒçˆï¼‰
        function updateSlot(index) {
            const el = document.getElementById(`slot-${index}`);
            if (!el) return;

            const itemIndex = currentState.sequence[index];
            const itemChar = currentState.items[itemIndex];
            const solvedCount = currentState.visibleCount + currentState.userProgress;
            
            const isSolved = index < solvedCount;
            const isNext = index === solvedCount;

            // é‡ç½®åŸºæœ¬æ¨£å¼ï¼Œä¿ç•™ transition
            el.className = `item-slot w-12 h-12 md:w-16 md:h-16 flex items-center justify-center text-2xl md:text-3xl rounded-xl shadow-sm border-2 flex-shrink-0 transition-all duration-300`;

            if (isSolved) {
                el.innerText = itemChar;
                el.classList.add('bg-white', 'border-slate-200');
                if (index === solvedCount - 1) { 
                    el.classList.add('pop-in'); // å‰›ç­”å°çš„æ ¼å­åŠ ä¸Šå‹•ç•«
                }
            } else if (isNext) {
                el.innerText = '?';
                el.classList.add('bg-blue-50', 'border-blue-300', 'border-dashed', 'animate-pulse', 'text-blue-400');
            } else {
                el.innerText = '';
                el.classList.add('bg-slate-100', 'border-slate-200', 'opacity-50');
            }
        }

        function renderOptions() {
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            currentState.items.forEach((char, index) => {
                const btn = document.createElement('button');
                btn.className = `
                    option-btn w-20 h-20 md:w-24 md:h-24 bg-white border-b-4 border-slate-200 rounded-2xl 
                    text-4xl md:text-5xl shadow-md flex items-center justify-center
                    hover:bg-blue-50 hover:border-blue-300 hover:-translate-y-1
                `;
                btn.innerText = char;
                btn.onclick = () => checkAnswer(index);
                container.appendChild(btn);
            });
        }

        function checkAnswer(selectedIndex) {
            const currentSlotIndex = currentState.visibleCount + currentState.userProgress;
            if (currentSlotIndex >= currentState.totalLength) return;

            const correctItemIndex = currentState.sequence[currentSlotIndex];

            if (selectedIndex === correctItemIndex) {
                playSound('correct'); // æ’­æ”¾ç­”å°éŸ³æ•ˆ
                currentState.userProgress++;

                // åˆ¤æ–·æ›´æ–°æ–¹å¼
                const patternLength = (['AB'].includes(currentState.patternType)) ? 2 : 3;
                const currentCount = currentState.visibleCount + currentState.userProgress;
                
                // å¦‚æœé–‹å•Ÿæç¤ºæ¨¡å¼ï¼Œä¸”å‰›å¥½å®Œæˆä¸€çµ„è¦å¾‹ï¼Œéœ€è¦é‡ç¹ªï¼ˆå› ç‚ºè¦åŠ ä¸Šå¤–æ¡†ï¼‰
                // å¦å‰‡ä½¿ç”¨å±€éƒ¨æ›´æ–°ï¼Œé¿å…é–ƒçˆ
                if (currentState.hintMode && (currentCount % patternLength === 0)) {
                    renderSequence();
                } else {
                    // å±€éƒ¨æ›´æ–°ï¼šæ›´æ–°å‰›å¡«å…¥çš„æ ¼å­
                    updateSlot(currentCount - 1);
                    // å±€éƒ¨æ›´æ–°ï¼šæ›´æ–°ä¸‹ä¸€å€‹å•è™Ÿï¼ˆå¦‚æœé‚„æ²’çµæŸï¼‰
                    if (currentCount < currentState.totalLength) {
                        updateSlot(currentCount);
                    }
                }

                if (currentCount >= currentState.totalLength) {
                    handleWin();
                }
            } else {
                playSound('wrong'); // æ’­æ”¾ç­”éŒ¯éŸ³æ•ˆ
                shakeGame();
            }
        }

        function handleWin() {
            playSound('win'); // æ’­æ”¾å‹åˆ©éŸ³æ•ˆ
            document.getElementById('options-container').classList.add('hidden');
            const winBtn = document.getElementById('next-level-btn');
            winBtn.classList.remove('hidden');
            
            const msg = document.getElementById('game-message');
            msg.innerText = "å®Œæˆï¼ä½ çœŸæ£’ï¼ğŸ‰";
            msg.className = "absolute top-2 left-1/2 transform -translate-x-1/2 text-green-600 font-bold text-xl animate__animated animate__bounceIn";
        }
        
        function nextLevel() {
            playSound('click');
            initGame();
        }

        // --- Interaction Helpers ---

        function setPattern(type) {
            playSound('click'); // æ’­æ”¾é»æ“ŠéŸ³æ•ˆ
            if (type === 'RANDOM') {
                currentState.isRandom = true;
            } else {
                currentState.isRandom = false;
                currentState.patternType = type;
            }
            
            updateButtonStyles(type);
            initGame();
        }

        function updateButtonStyles(activeType) {
            const allTypes = [...PATTERN_TYPES, 'RANDOM'];
            
            allTypes.forEach(p => {
                const btnId = `btn-${p.toLowerCase()}`;
                const btn = document.getElementById(btnId);
                if (!btn) return;

                const isActive = (p === activeType);
                
                // Base styles
                let cls = "px-3 py-1.5 rounded-md text-sm font-bold transition-colors ";
                
                // Special style for Random button
                if (p === 'RANDOM') {
                    cls += "border-l border-slate-300 ml-1 pl-3 ";
                    if (isActive) {
                        cls += "bg-purple-100 text-purple-700 shadow border-purple-200";
                    } else {
                        cls += "text-purple-600 hover:bg-slate-200";
                    }
                } else {
                    // Regular buttons
                    if (isActive) {
                        cls += "bg-white shadow text-blue-600 border border-slate-100";
                    } else {
                        cls += "text-slate-500 hover:bg-slate-200";
                    }
                }
                
                btn.className = cls;
            });
        }

        function changeTheme() {
            // playSound('click'); // ä¸‹æ‹‰é¸å–®é»æ“ŠéŸ³æ•ˆå¯èƒ½å¤ªé »ç¹ï¼Œå¯ä¸åŠ 
            const select = document.getElementById('theme-select');
            currentState.theme = select.value;
            initGame();
        }

        function toggleHint() {
            playSound('click'); // æ’­æ”¾é»æ“ŠéŸ³æ•ˆ
            currentState.hintMode = !currentState.hintMode;
            
            const btn = document.getElementById('btn-hint');
            const status = document.getElementById('hint-status');

            if (currentState.hintMode) {
                btn.classList.add('bg-yellow-50', 'border-yellow-300', 'text-yellow-600');
                btn.classList.remove('text-slate-500', 'border-slate-200');
                status.innerText = "é–‹å•Ÿ";
                status.classList.remove('bg-slate-200');
                status.classList.add('bg-yellow-200');
            } else {
                btn.classList.remove('bg-yellow-50', 'border-yellow-300', 'text-yellow-600');
                btn.classList.add('text-slate-500', 'border-slate-200');
                status.innerText = "é—œé–‰";
                status.classList.add('bg-slate-200');
                status.classList.remove('bg-yellow-200');
            }

            renderSequence(); // åˆ‡æ›æç¤ºæ¨¡å¼å¿…é ˆé‡ç¹ªçµæ§‹
        }

        function shakeGame() {
            const track = document.getElementById('sequence-track');
            track.classList.add('animate__animated', 'animate__headShake');
            setTimeout(() => {
                track.classList.remove('animate__animated', 'animate__headShake');
            }, 500);
        }

        function playFeedback(isCorrect) {
            // Placeholder for visual feedback, sound handled in playSound
        }

    </script>
</body>
</html>
