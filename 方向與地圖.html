<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éš¨æ©Ÿåœ°åœ–ç”Ÿæˆå™¨èˆ‡æ–¹å‘ç·´ç¿’</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªè¨‚ä¸€äº›ç°¡å–®çš„å‹•ç•«èˆ‡å­—é«”å¾®èª¿ */
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; }
        .emoji-shadow { text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; padding-right: 2rem !important; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- é é¢æ¨™é¡Œ -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-2">ğŸ—ºï¸ éš¨æ©Ÿåœ°åœ–èˆ‡æ–¹å‘ç·´ç¿’</h1>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- å·¦å´å€åŸŸï¼šæŒ‡å—é‡èˆ‡åœ°åœ– -->
            <div class="w-full lg:w-[450px] lg:shrink-0 flex flex-col gap-6">
                
                <!-- æŒ‡å—é‡å€å¡Š (ç§»è‡³å·¦ä¸Š) -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200 flex flex-col items-center">
                    <h2 class="text-xl font-bold text-slate-700 mb-4">ğŸ§­ ç›®å‰æ–¹ä½</h2>
                    <div class="relative w-24 h-24 rounded-full border-[3px] border-slate-200 bg-slate-50 flex items-center justify-center shadow-inner">
                        <!-- å·²ç§»é™¤ã€Œç•«é¢æ­£ä¸Šæ–¹ã€æç¤ºè© -->
                        
                        <!-- æ—‹è½‰çš„æŒ‡é‡ -->
                        <div id="compass-arrow" class="absolute w-full h-full transition-transform duration-1000 ease-in-out">
                            <!-- åŒ—æ–¹ç´…è‰²ç®­é ­ -->
                            <div class="absolute top-1.5 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[9px] border-r-[9px] border-b-[34px] border-l-transparent border-r-transparent border-b-red-500"></div>
                            <!-- åŒ—æ–¹æ¨™å­— -->
                            <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-3 font-black text-red-600 text-base bg-white/80 px-1 rounded">åŒ—</div>
                            <!-- å—æ–¹é»‘è‰²ç®­é ­ -->
                            <div class="absolute bottom-1.5 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[9px] border-r-[9px] border-t-[34px] border-l-transparent border-r-transparent border-t-slate-800"></div>
                        </div>
                    </div>
                    <!-- å·²ç§»é™¤ compass-desc æ–‡å­—èªªæ˜æ®µè½ -->
                </div>

                <!-- åœ°åœ–å€å¡Š -->
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-md border border-slate-200">
                    <h2 class="text-xl font-bold text-slate-700 mb-4 text-center">ğŸ“ åœ°åœ–</h2>
                    <div id="map-grid" class="grid grid-cols-4 gap-2 md:gap-3 bg-slate-200 p-2 md:p-3 rounded-xl max-w-[400px] mx-auto">
                        <!-- åœ°åœ–æ–¹å¡Šç”± JS ç”¢ç”Ÿ -->
                    </div>
                </div>
            </div>

            <!-- å³å´å€åŸŸï¼šé¡Œç›® -->
            <div class="w-full lg:flex-1 flex flex-col gap-6 min-w-0">
                
                <!-- é¡Œç›®èˆ‡è¨­å®šå€å¡Š (å³å´) -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200 flex flex-col flex-grow">
                
                    <!-- è¨­å®šå€åŸŸ -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-6 border-b pb-4 gap-4">
                        <div class="flex flex-col gap-2 w-full sm:w-auto">
                            <h2 class="text-2xl font-bold text-slate-800">ğŸ“ é¡Œç›®æ¸¬é©—</h2>
                            <div class="flex gap-2 text-sm">
                                <select id="setting-dir-mode" class="border border-slate-300 bg-slate-50 text-slate-700 py-1 px-2 rounded font-medium focus:ring focus:ring-blue-200">
                                    <option value="8">å…«å€‹æ–¹å‘</option>
                                    <option value="4" selected>å››å€‹æ–¹å‘</option>
                                </select>
                                <select id="setting-q-mode" class="border border-slate-300 bg-slate-50 text-slate-700 py-1 px-2 rounded font-medium focus:ring focus:ring-blue-200">
                                    <option value="mixed">éš¨æ©Ÿæ··åˆ</option>
                                    <option value="1" selected>æ–¹å‘é¡Œå‹</option>
                                    <option value="2">åœ°åœ–ç‰©ä»¶é¡Œå‹</option>
                                    <option value="3">é€²éšé¡Œå‹</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="generateNewSession()" class="whitespace-nowrap px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg shadow transition-colors w-full sm:w-auto">é‡æ–°ç”Ÿæˆ</button>
                    </div>

                    <!-- ç­”é¡Œå€åŸŸ (æ¯æ¬¡åªé¡¯ç¤ºä¸€é¡Œ) -->
                    <div id="question-area" class="flex flex-col flex-grow">
                        <div class="flex justify-between items-center mb-4 text-slate-500 font-bold">
                            <span>é€²åº¦ï¼šç¬¬ <span id="current-q-num" class="text-blue-600 text-lg">1</span> / 5 é¡Œ</span>
                            <span>å¾—åˆ†ï¼š<span id="current-score" class="text-green-600 text-lg">0</span></span>
                        </div>

                        <!-- å–®é¡Œå®¹å™¨ -->
                        <div id="single-question-container" class="p-6 bg-slate-50 rounded-xl border border-slate-200 flex flex-col gap-4 text-4xl shadow-sm mb-6 min-h-[160px] justify-center">
                            <!-- é¡Œç›®ç”± JS ç”¢ç”Ÿ -->
                        </div>

                        <!-- æ“ä½œæŒ‰éˆ•èˆ‡å›é¥‹ -->
                        <div class="flex flex-col gap-4 mt-auto">
                            <div id="feedback-message" class="text-center font-bold text-lg h-8"></div>
                            
                            <button id="btn-submit" onclick="checkAnswer()" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow-md transition-colors text-lg">é€å‡ºç­”æ¡ˆ</button>
                            
                            <button id="btn-next" onclick="nextQuestion()" class="hidden w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg shadow-md transition-colors text-lg">ä¸‹ä¸€é¡Œ â¡ï¸</button>

                            <button id="btn-result" onclick="showResults()" class="hidden w-full py-3 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-lg shadow-md transition-colors text-lg">æŸ¥çœ‹ç¸½çµ ğŸ†</button>
                        </div>
                    </div>
                    
                    <!-- çµæœçµç®—å€åŸŸ -->
                    <div id="result-area" class="hidden flex flex-col items-center justify-center flex-grow py-8">
                        <h3 class="text-3xl font-black text-slate-800 mb-4">æ¸¬é©—çµæŸï¼</h3>
                        <div id="final-score-display" class="text-5xl font-extrabold mb-6"></div>
                        <div id="final-message" class="text-xl text-slate-600 font-bold text-center mb-8 px-4"></div>
                        <button onclick="generateNewSession()" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full shadow-lg transition-transform hover:scale-105 text-xl">å†ç©ä¸€æ¬¡</button>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script>
        // å®šç¾©ä½¿ç”¨çš„ 16 å€‹åœ–æ¡ˆ (Emojis)
        const iconsList = ['ğŸŒ²', 'ğŸ ', 'â›°ï¸', 'â›º', 'ğŸ°', 'â›ª', 'â›²', 'ğŸ­', 'ğŸ«', 'ğŸ¥', 'ğŸ¦', 'ğŸª', 'ğŸš‚', 'â›µ', 'âœˆï¸', 'ğŸš€'];
        
        // 8 å€‹æ–¹ä½åç¨±
        const dirNames8 = ['åŒ—', 'æ±åŒ—', 'æ±', 'æ±å—', 'å—', 'è¥¿å—', 'è¥¿', 'è¥¿åŒ—'];
        // 4 å€‹æ–¹ä½åç¨±
        const dirNames4 = ['åŒ—', 'æ±', 'å—', 'è¥¿'];
        
        // å®šç¾©è¢å¹•ä¸Šçš„ 8 å€‹ç§»å‹•å‘é‡ [dx (æ©«å‘), dy (ç›´å‘)]
        const screenVectors = [
            [0, -1],  // 0: ä¸Š
            [1, -1],  // 1: å³ä¸Š
            [1, 0],   // 2: å³
            [1, 1],   // 3: å³ä¸‹
            [0, 1],   // 4: ä¸‹
            [-1, 1],  // 5: å·¦ä¸‹
            [-1, 0],  // 6: å·¦
            [-1, -1]  // 7: å·¦ä¸Š
        ];

        let currentNorthIndex = 0; 
        let currentMap = []; 
        
        // æ¸¬é©—ç‹€æ…‹
        let currentQuestionNum = 1;
        const maxQuestions = 5;
        let score = 0;
        let currentQuestionData = null;
        let currentSelectedAnswer = ""; // è¨˜éŒ„ç•¶å‰é¸æ“‡çš„ç­”æ¡ˆ

        // é™£åˆ—æ´—ç‰Œå‡½æ•¸
        function shuffle(array) {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // åˆå§‹åŒ–èˆ‡ç”Ÿæˆæ–°é—œå¡
        function generateNewSession() {
            currentQuestionNum = 1;
            score = 0;
            updateScoreDisplay();
            
            // åˆ‡æ›ç•«é¢
            document.getElementById('result-area').classList.add('hidden');
            document.getElementById('question-area').classList.remove('hidden');
            document.getElementById('question-area').classList.add('flex');

            // 1. ç”Ÿæˆæ‰“äº‚çš„åœ°åœ–
            const shuffledIcons = shuffle(iconsList);
            currentMap = [];
            for (let i = 0; i < 4; i++) {
                currentMap.push(shuffledIcons.slice(i * 4, i * 4 + 4));
            }

            // 2. æ¸²æŸ“åœ°åœ–ç•«é¢
            const mapGrid = document.getElementById('map-grid');
            mapGrid.innerHTML = '';
            for (let r = 0; r < 4; r++) {
                for (let c = 0; c < 4; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'aspect-square flex items-center justify-center text-5xl lg:text-[4rem] bg-white border border-slate-300 rounded-xl shadow-sm hover:scale-105 transition-transform cursor-default select-none emoji-shadow';
                    cell.innerText = currentMap[r][c];
                    mapGrid.appendChild(cell);
                }
            }

            // 3. éš¨æ©Ÿæ±ºå®šæŒ‡å—é‡æ–¹å‘ (ä¾æ“šé¸æ“‡çš„æ¨¡å¼é™åˆ¶åŒ—æ–¹æŒ‡å‘)
            const dirMode = document.getElementById('setting-dir-mode').value;
            if (dirMode === '4') {
                // å¦‚æœæ˜¯ 4 æ–¹å‘ï¼Œè®“æŒ‡å—é‡ä¹ŸåªæŒ‡å‘æ­£ä¸Šã€å³ã€ä¸‹ã€å·¦ï¼Œé¿å…æ··æ·†
                const dirs4 = [0, 2, 4, 6];
                currentNorthIndex = dirs4[Math.floor(Math.random() * dirs4.length)];
            } else {
                currentNorthIndex = Math.floor(Math.random() * 8);
            }
            
            const degrees = currentNorthIndex * 45;
            document.getElementById('compass-arrow').style.transform = `rotate(${degrees}deg)`;
            
            // å·²ç§»é™¤è¨­å®š compass-desc çš„ JS ç¨‹å¼ç¢¼

            // 4. æ¸²æŸ“ç¬¬ä¸€é¡Œ
            renderCurrentQuestion();
        }

        // å°‹æ‰¾ç¬¦åˆæ¢ä»¶çš„ä¸€çµ„åœ–æ¡ˆèˆ‡æ–¹ä½
        function getValidPair(type, dirMode) {
            let maxTries = 300;
            while (maxTries-- > 0) {
                let rB = Math.floor(Math.random() * 4);
                let cB = Math.floor(Math.random() * 4);
                
                let dirIndex;
                if (dirMode === '4') {
                    const dirs4 = [0, 2, 4, 6]; // åŒ—, æ±, å—, è¥¿
                    dirIndex = dirs4[Math.floor(Math.random() * dirs4.length)];
                } else {
                    dirIndex = Math.floor(Math.random() * 8);
                }
                
                // åœ°åœ–ç‰©ä»¶é¡Œå‹ (Type 2) è·é›¢é™åˆ¶ç‚º 1ã€‚é€²éšé¡Œå‹ (Type 3) ä¸é™è·é›¢ï¼Œå…è¨±ç”¢ç”Ÿå¤šå€‹ç­”æ¡ˆã€‚
                let dist = (type === 2) ? 1 : (Math.floor(Math.random() * 3) + 1);

                let screenDirIndex = (dirIndex + currentNorthIndex) % 8;
                let dx = screenVectors[screenDirIndex][0];
                let dy = screenVectors[screenDirIndex][1];

                let rA = rB + dist * dy;
                let cA = cB + dist * dx;

                if (rA >= 0 && rA < 4 && cA >= 0 && cA < 4) {
                    return {
                        B: { icon: currentMap[rB][cB], r: rB, c: cB },
                        A: { icon: currentMap[rA][cA], r: rA, c: cA },
                        dirIndex: dirIndex,
                        dirName: dirNames8[dirIndex], // åç¨±æ°¸é å¯å°æ‡‰8æ–¹ä½é™£åˆ—
                        screenDirIndex: screenDirIndex
                    };
                }
            }
            return null;
        }

        // æ¸²æŸ“å–®ä¸€é¡Œç›®
        function renderCurrentQuestion() {
            document.getElementById('current-q-num').innerText = currentQuestionNum;
            document.getElementById('feedback-message').innerHTML = ''; // æ¸…é™¤å›é¥‹
            currentSelectedAnswer = ""; // é‡è¨­é¸æ“‡ç­”æ¡ˆ
            
            // é‡è¨­æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('btn-submit').classList.remove('hidden');
            document.getElementById('btn-next').classList.add('hidden');
            document.getElementById('btn-result').classList.add('hidden');

            const dirMode = document.getElementById('setting-dir-mode').value;
            const qMode = document.getElementById('setting-q-mode').value;
            
            // æ±ºå®šé¡Œå‹ (1:æ–¹å‘, 2:åœ°åœ–ç‰©ä»¶, 3:é€²éš)
            let type;
            if (qMode === '1') type = 1;
            else if (qMode === '2') type = 2;
            else if (qMode === '3') type = 3;
            else {
                const types = [1, 2, 3];
                type = types[Math.floor(Math.random() * types.length)];
            }

            currentQuestionData = getValidPair(type, dirMode);
            if (!currentQuestionData) {
                // é˜²å‘†é‡è©¦
                renderCurrentQuestion();
                return;
            }

            // è¨ˆç®—æ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„æ­£ç¢ºç­”æ¡ˆ
            let validAnswers = [];
            if (type === 1) {
                validAnswers = [currentQuestionData.dirName];
            } else if (type === 2) {
                validAnswers = [currentQuestionData.A.icon];
            } else if (type === 3) {
                // é€²éšé¡Œå‹ï¼šå°‹æ‰¾é€™æ¢ç›´ç·šä¸Šæ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„åŸºæº–é» (åœ–æ¡ˆB)
                let rA = currentQuestionData.A.r;
                let cA = currentQuestionData.A.c;
                let dx = screenVectors[currentQuestionData.screenDirIndex][0];
                let dy = screenVectors[currentQuestionData.screenDirIndex][1];
                for (let d = 1; d <= 3; d++) {
                    let rCand = rA - d * dy;
                    let cCand = cA - d * dx;
                    if (rCand >= 0 && rCand < 4 && cCand >= 0 && cCand < 4) {
                        validAnswers.push(currentMap[rCand][cCand]);
                    }
                }
            }
            // è½‰æˆå­—ä¸²å±¬æ€§å­˜æ”¾
            const answersAttr = validAnswers.join(',');

            const container = document.getElementById('single-question-container');
            container.innerHTML = '';

            // é¡Œç›®å¥å­å®¹å™¨
            const qDiv = document.createElement('div');
            qDiv.className = 'flex flex-wrap items-center justify-center gap-4 leading-loose text-center mb-8';

            // éš¨æ©Ÿæ±ºå®šå¥å‹çµæ§‹ (1: A åœ¨ B çš„æ–¹å‘æ–¹, 2: B çš„æ–¹å‘æ–¹æ˜¯ A)
            const sentenceStruct = Math.random() > 0.5 ? 1 : 2;

            // é¸é …æŒ‰éˆ•å®¹å™¨èˆ‡ç‹€æ…‹
            const optionsDiv = document.createElement('div');
            let optionsType = ""; // 'dir' æˆ– 'icon'

            if (type === 1) {
                // --- 1. æ–¹å‘é¡Œå‹ --- (æŒ–ç©º: æ–¹å‘)
                optionsType = 'dir';
                
                if (sentenceStruct === 1) {
                    qDiv.innerHTML += `<span><span class="text-7xl mx-2">${currentQuestionData.A.icon}</span> åœ¨ <span class="text-7xl mx-2">${currentQuestionData.B.icon}</span> çš„</span>`;
                    qDiv.innerHTML += `<span id="answer-blank" class="inline-block min-w-[7.5rem] border-b-[4px] border-slate-400 text-blue-700 font-bold text-center px-3 text-5xl" data-answers="${answersAttr}">?</span>`;
                    qDiv.innerHTML += `<span>æ–¹ã€‚</span>`;
                } else {
                    qDiv.innerHTML += `<span><span class="text-7xl mx-2">${currentQuestionData.B.icon}</span> çš„</span>`;
                    qDiv.innerHTML += `<span id="answer-blank" class="inline-block min-w-[7.5rem] border-b-[4px] border-slate-400 text-blue-700 font-bold text-center px-3 text-5xl" data-answers="${answersAttr}">?</span>`;
                    qDiv.innerHTML += `<span>æ–¹æ˜¯ <span class="text-7xl mx-2">${currentQuestionData.A.icon}</span></span>`;
                    qDiv.innerHTML += `<span>ã€‚</span>`;
                }

            } else if (type === 2) {
                // --- 2. åœ°åœ–ç‰©ä»¶é¡Œå‹ --- (æŒ–ç©º: åœ–æ¡ˆA / è¢«æŒ‡åˆ°çš„ç‰©ä»¶)
                optionsType = 'icon';

                if (sentenceStruct === 1) {
                    qDiv.innerHTML += `<span id="answer-blank" class="inline-block min-w-[7.5rem] border-b-[4px] border-slate-400 text-blue-700 font-bold text-center px-3 text-7xl" data-answers="${answersAttr}">?</span>`;
                    qDiv.innerHTML += `<span>åœ¨ <span class="text-7xl mx-2">${currentQuestionData.B.icon}</span> çš„ <strong class="text-indigo-600 text-6xl mx-3">${currentQuestionData.dirName}</strong> æ–¹ã€‚</span>`;
                } else {
                    qDiv.innerHTML += `<span><span class="text-7xl mx-2">${currentQuestionData.B.icon}</span> çš„ <strong class="text-indigo-600 text-6xl mx-3">${currentQuestionData.dirName}</strong> æ–¹æ˜¯</span>`;
                    qDiv.innerHTML += `<span id="answer-blank" class="inline-block min-w-[7.5rem] border-b-[4px] border-slate-400 text-blue-700 font-bold text-center px-3 text-7xl" data-answers="${answersAttr}">?</span>`;
                }

            } else if (type === 3) {
                // --- 3. é€²éšé¡Œå‹ --- (æŒ–ç©º: åœ–æ¡ˆB / åŸºæº–é»ç‰©ä»¶)
                optionsType = 'icon';

                if (sentenceStruct === 1) {
                    qDiv.innerHTML += `<span><span class="text-7xl mx-2">${currentQuestionData.A.icon}</span> åœ¨</span>`;
                    qDiv.innerHTML += `<span id="answer-blank" class="inline-block min-w-[7.5rem] border-b-[4px] border-slate-400 text-blue-700 font-bold text-center px-3 text-7xl" data-answers="${answersAttr}">?</span>`;
                    qDiv.innerHTML += `<span>çš„ <strong class="text-indigo-600 text-6xl mx-3">${currentQuestionData.dirName}</strong> æ–¹ã€‚</span>`;
                } else {
                    qDiv.innerHTML += `<span id="answer-blank" class="inline-block min-w-[7.5rem] border-b-[4px] border-slate-400 text-blue-700 font-bold text-center px-3 text-7xl" data-answers="${answersAttr}">?</span>`;
                    qDiv.innerHTML += `<span>çš„ <strong class="text-indigo-600 text-6xl mx-3">${currentQuestionData.dirName}</strong> æ–¹æ˜¯ <span class="text-7xl mx-2">${currentQuestionData.A.icon}</span></span>`;
                    qDiv.innerHTML += `<span>ã€‚</span>`;
                }
            }

            // æ ¹æ“šé¡Œå‹ç”Ÿæˆå°æ‡‰çš„é¸é …æŒ‰éˆ•
            if (optionsType === 'dir') {
                optionsDiv.className = 'flex flex-wrap justify-center gap-4';
                const optionsList = dirMode === '4' ? dirNames4 : dirNames8;
                optionsList.forEach(opt => {
                    optionsDiv.innerHTML += `<button onclick="selectOption(this, '${opt}')" class="opt-btn px-8 py-4 bg-white border-2 border-slate-200 rounded-lg shadow-sm hover:border-blue-400 hover:bg-blue-50 focus:outline-none transition-all text-3xl font-bold text-slate-700">${opt}</button>`;
                });
            } else {
                optionsDiv.className = 'grid grid-cols-4 sm:grid-cols-8 gap-3';
                iconsList.forEach(opt => {
                    optionsDiv.innerHTML += `<button onclick="selectOption(this, '${opt}')" class="opt-btn aspect-square flex items-center justify-center bg-white border-2 border-slate-200 rounded-lg shadow-sm hover:border-blue-400 hover:bg-blue-50 focus:outline-none transition-all text-5xl emoji-shadow">${opt}</button>`;
                });
            }

            container.appendChild(qDiv);
            container.appendChild(optionsDiv);
        }

        // é¸æ“‡é¸é …
        function selectOption(btnElement, val) {
            // å¦‚æœå·²ç¶“é€å‡ºç­”æ¡ˆï¼Œå‰‡ä¸å¯å†é»é¸
            if (document.getElementById('btn-submit').classList.contains('hidden')) return;

            currentSelectedAnswer = val;
            const blank = document.getElementById('answer-blank');
            blank.innerText = val;
            blank.classList.remove('border-slate-400');
            blank.classList.add('border-blue-500', 'text-blue-700');

            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.opt-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-blue-300', 'border-blue-500', 'bg-blue-50');
            });

            // æ¨™ç¤ºç•¶å‰é¸ä¸­çš„æŒ‰éˆ•
            btnElement.classList.add('ring-4', 'ring-blue-300', 'border-blue-500', 'bg-blue-50');
        }

        // æ‰¹æ”¹å–®ä¸€ç­”æ¡ˆ
        function checkAnswer() {
            if (!currentSelectedAnswer) {
                alert("è«‹å…ˆé»æ“Šä¸‹æ–¹é¸é …å¡«å…¥ç­”æ¡ˆå–”ï¼");
                return;
            }

            const blank = document.getElementById('answer-blank');
            const validAnswers = blank.dataset.answers.split(',');
            const isCorrect = validAnswers.includes(currentSelectedAnswer);
            const feedback = document.getElementById('feedback-message');
            
            if (isCorrect) {
                blank.classList.remove('border-blue-500', 'text-blue-700');
                blank.classList.add('border-green-500', 'text-green-700');
                feedback.innerHTML = '<span class="text-green-600">âœ… ç­”å°äº†ï¼éå¸¸æ£’ï¼</span>';
                score++;
                updateScoreDisplay();
            } else {
                blank.classList.remove('border-blue-500', 'text-blue-700');
                blank.classList.add('border-red-500', 'text-red-600');
                const correctAnswersStr = validAnswers.join(" æˆ– ");
                feedback.innerHTML = `<span class="text-red-600">âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<strong>${correctAnswersStr}</strong></span>`;
            }
            
            // åœç”¨æ‰€æœ‰é¸é …æŒ‰éˆ•
            document.querySelectorAll('.opt-btn').forEach(btn => {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.onclick = null;
            });

            // åˆ‡æ›æŒ‰éˆ•
            document.getElementById('btn-submit').classList.add('hidden');
            if (currentQuestionNum < maxQuestions) {
                document.getElementById('btn-next').classList.remove('hidden');
            } else {
                document.getElementById('btn-result').classList.remove('hidden');
            }
        }

        // é€²å…¥ä¸‹ä¸€é¡Œ
        function nextQuestion() {
            currentQuestionNum++;
            renderCurrentQuestion();
        }

        // é¡¯ç¤ºæœ€çµ‚çµç®—
        function showResults() {
            document.getElementById('question-area').classList.add('hidden');
            document.getElementById('question-area').classList.remove('flex');
            
            document.getElementById('result-area').classList.remove('hidden');
            
            const scoreDisplay = document.getElementById('final-score-display');
            const finalMsg = document.getElementById('final-message');
            
            scoreDisplay.innerText = `${score} / ${maxQuestions}`;
            
            if(score === maxQuestions) {
                scoreDisplay.className = 'text-5xl font-extrabold mb-6 text-green-600';
                finalMsg.innerText = `ğŸ‰ å¤ªç¥å•¦ï¼å®Œç¾éé—œï¼Œä½ çš„æ–¹å‘æ„Ÿè¶…æ£’ï¼`;
            } else if (score >= 3) {
                scoreDisplay.className = 'text-5xl font-extrabold mb-6 text-yellow-500';
                finalMsg.innerText = `ğŸ‘ è¡¨ç¾ä¸éŒ¯ï¼ç¹¼çºŒä¿æŒç·´ç¿’ï¼Œä½ æœƒè¶Šä¾†è¶Šç†Ÿç·´ï¼`;
            } else {
                scoreDisplay.className = 'text-5xl font-extrabold mb-6 text-red-500';
                finalMsg.innerText = `ğŸ’ª å†æ¥å†å²ï¼çœ‹åœ°åœ–æ™‚è¨˜å¾—è¦å…ˆç¢ºèªæŒ‡å—é‡çš„åŒ—æ–¹åœ¨å“ªè£¡å–”ï¼`;
            }
        }

        function updateScoreDisplay() {
            document.getElementById('current-score').innerText = score;
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œç¬¬ä¸€æ¬¡ç”Ÿæˆ
        window.onload = generateNewSession;
    </script>
</body>
</html>
